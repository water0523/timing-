<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>沉浸式专注计时器</title>
    <style>
        /* --- 全局样式 & 重置 --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body, html {
            margin: 0; padding: 0;
            width: 100%; height: 100%;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            overflow: hidden; /* 禁止整体滚动 */
            background-color: #fff;
            color: #333;
        }

        /* --- 场景容器 --- */
        .screen {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            display: none;
            flex-direction: column;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .screen.active {
            display: flex;
            opacity: 1;
            z-index: 10;
        }

        /* ==============================
           场景 1: 设置页面 (复刻图2、图4风格)
           ============================== */
        #setup-screen {
            background: #fff;
            padding: 24px;
            position: relative;
        }

        /* 标题部分 */
        .section-title {
            font-size: 20px;
            font-weight: bold;
            color: #333;
            margin-top: 20px;
            margin-bottom: 15px;
        }

        /* 输入框样式 */
        .input-group {
            margin-bottom: 40px;
        }

        .clean-input {
            width: 100%;
            padding: 10px 0;
            font-size: 18px;
            border: none;
            border-bottom: 1px solid #eee;
            outline: none;
            color: #555;
            background: transparent;
            border-radius: 0;
        }
        .clean-input::placeholder { color: #ccc; }

       /* --- CSS 修改部分 --- */

        /* 外层容器：负责左右布局，去掉了原来的 border-bottom */
        .duration-trigger-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            padding-bottom: 5px;
            cursor: pointer;
            margin-top: 10px;
        }

        /* 左侧提示文字 */
        .hint-text {
            font-size: 14px;
            color: #ccc; /* 默认灰色，设置后变金/橙色 */
            margin-bottom: 5px; /*为了和右边对齐 */
        }

/* 找到这一块，修改为： */
        .time-value-wrapper {
            /* 删掉或者注释掉下面这一行，默认不显示横线 */
            /* border-bottom: 2px solid #2196F3; */ 
            
            padding-bottom: 5px;
            min-width: 60px;
            text-align: right;
        }

        /* 数值文字样式 */
        .duration-display {
            font-size: 24px;
            font-weight: bold;
            color: #2196F3;
        }
        
        /* 单位（小时）样式 */
        .duration-unit {
            font-size: 16px;
            color: #333;
            margin-left: 5px;
            font-weight: normal;
        }

        /* 底部开始按钮 */
        .start-btn-container {
            position: absolute;
            bottom: 0; left: 0;
            width: 100%;
        }
        .start-btn {
            width: 100%;
            padding: 20px;
            background: #2196F3;
            color: white;
            font-size: 20px;
            border: none;
            font-weight: bold;
            cursor: pointer;
        }
        .start-btn:active { background: #1976D2; }

        /* ==============================
           弹窗: iOS 时间选择器 (复刻图3)
           ============================== */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.4);
            z-index: 50;
            visibility: hidden;
            opacity: 0;
            transition: all 0.3s;
        }
        .modal-overlay.open {
            visibility: visible;
            opacity: 1;
        }

        .picker-modal {
            position: fixed;
            bottom: 0; left: 0;
            width: 100%;
            background: #f2f2f2;
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
            z-index: 51;
            padding-bottom: 20px;
        }
        .picker-modal.open {
            transform: translateY(0);
        }

        /* 弹窗顶部工具栏 */
        .picker-toolbar {
            display: flex;
            justify-content: space-between;
            padding: 15px 20px;
            background: #fff;
            border-bottom: 1px solid #ddd;
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
        }
        .toolbar-btn {
            font-size: 16px;
            border: none;
            background: none;
            cursor: pointer;
        }
        .btn-cancel { color: #888; }
        .btn-confirm { color: #2196F3; font-weight: bold; font-size: 18px; }

        /* 选择器容器 */
        .ios-picker-wrapper {
            position: relative;
            width: 100%;
            height: 240px;
            display: flex;
            justify-content: center;
            overflow: hidden;
            background: #f2f2f2;
            /* 渐变遮罩 */
            mask-image: linear-gradient(to bottom, transparent, black 40%, black 60%, transparent);
            -webkit-mask-image: linear-gradient(to bottom, transparent 5%, black 40%, black 60%, transparent 95%);
        }

        /* 高亮条 */
        .picker-highlight {
            position: absolute;
            top: 50%; left: 0;
            width: 100%; height: 44px;
            margin-top: -22px;
            background: rgba(255,255,255,0.7);
            border-top: 1px solid #ccc;
            border-bottom: 1px solid #ccc;
            pointer-events: none;
            z-index: 0;
        }

/* --- 找到这个类，修改如下 --- */
        .picker-column {
            flex: 1;
            max-width: 100px;
            height: 100%;
            overflow-y: scroll;
            scrollbar-width: none;
            scroll-snap-type: y mandatory; /* 这是滚轮和原生滚动的吸附 */
            padding: 0;
            position: relative;
            z-index: 1;
            text-align: center;
            
            /* === 新增部分开始 === */
            cursor: grab;       /* 鼠标放上去显示抓取手势 */
            user-select: none;  /* 禁止拖拽时选中文本 */
            /* === 新增部分结束 === */
        }

        .picker-column::-webkit-scrollbar { display: none; }
        
        /* === 新增：按下时显示“紧抓”手势 === */
        .picker-column:active {
            cursor: grabbing;
        }

        .picker-item {
            height: 44px; /* 对应 highlight 高度 */
            line-height: 44px;
            font-size: 22px;
            color: #999;
            scroll-snap-align: center;
            transition: all 0.2s;
        }
        .picker-placeholder { height: 98px; } /* (240 - 44)/2 */

        .picker-label-text {
            line-height: 240px; /* 垂直居中 */
            font-size: 16px;
            font-weight: bold;
            color: #333;
            margin: 0 10px;
            z-index: 2;
        }

        /* ==============================
           场景 2: 计时器页面 (全屏沉浸)
           ============================== */
        #timer-screen {
            justify-content: center;
            align-items: center;
            color: white;
            background: #000; /* 默认黑底，防止图片加载前的白屏 */
        }

        /* 找到 .bg-layer，替换为以下代码 */
        .bg-layer {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            
            /* 关键点1：图片放大到 120%，这样左右才有空间移动 */
            background-size: 120% 120%; 
            background-position: center;
            z-index: 0;
            opacity: 0.8;
            transition: background-image 1s ease-in-out;
            
            /* 关键点2：时长设为 20s，配合 alternate (往返) 
               去程 20s + 回程 20s = 40s 一个循环 */
            animation: moveBg 20s linear infinite alternate;
        }

        /* 找到 @keyframes moveBg，替换为以下代码 */
        @keyframes moveBg {
            0% { 
                /* 最左侧：图片的左边缘对齐屏幕左边缘 */
                background-position: 0% 50%; 
            }
            100% { 
                /* 最右侧：图片的右边缘对齐屏幕右边缘 */
                background-position: 100% 50%; 
            }
        }

        .overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.3);
            z-index: 1;
        }

        /* 进度环容器 */
        .timer-circle {
            position: relative;
            width: 300px; height: 300px;
            z-index: 5;
        }
        svg { transform: rotate(-90deg); width: 100%; height: 100%; }
        circle { fill: none; stroke-width: 5; stroke-linecap: round; }
        .circle-bg { stroke: rgba(255,255,255,0.2); }
        .circle-progress { 
            stroke: #fff; 
            /* transition: stroke-dashoffset 0.1s linear;  <-- 务必删掉或注释掉这一行 */
        }

/* --- 核心容器：填满整个圆盘，不再依赖 translate 居中 --- */
        .timer-content {
            position: absolute;
            top: 0; left: 0;
            width: 100%; 
            height: 100%; /* 填满父容器(300x300) */
            
            display: flex;
            flex-direction: column; 
            align-items: center;
            justify-content: center; /* 内部内容居中 */
            
            /* 只做旋转，不移动位置，根除抖动源 */
            transform: perspective(600px) rotateY(0deg);
            transform-style: preserve-3d;
            backface-visibility: hidden;
            
            /* 动画设置 */
            transition: transform 0.5s linear, opacity 0.1s linear; 
            
            /* 硬件加速 */
            will-change: transform, opacity;
        }

        /* === 默认状态（图2）：时间在上，任务在下 === */
        
/* === 默认状态（图2）：时间是大字，文案是小字 === */
        
        .main-time {
            /* 默认顺序：1 */
            order: 1;
            
            font-size: 64px;
            /* 【修改点1】加粗：从 200 改为 400 (normal) */
            font-weight: 350; 
            letter-spacing: 2px;
            line-height: 1.2;
            /* 【修改点2】不透明度：拉满到 1 */
            color: rgba(255, 255, 255, 1); 
            margin: 0;
            transition: font-size 0.1s;
            /* 增加一点文字阴影增强清晰度 */
            text-shadow: 0 2px 4px rgba(0,0,0,0.1); 
        }

        .task-name-display {
            /* 默认顺序：2 */
            order: 2;
            
            font-size: 20px;
            font-weight: 500;
            /* 小字稍微淡一点点 */
            opacity: 0.9; 
            margin-top: 5px;
            letter-spacing: 1px;
            color: rgba(255,255,255,0.9);
            transition: font-size 0.1s;
        }

        /* === 初始模式（图1）：任务是大字，时间是小字 === */
        
        .timer-content.initial-mode .main-time {
            order: 2; /* 跑到下面 */
            
            font-size: 20px;
            font-weight: 350; /* 保持一致的字重，或者稍微细一点 */
            letter-spacing: 1px;
            opacity: 0.9;
            margin-top: 10px;
        }

        .timer-content.initial-mode .task-name-display {
            order: 1; /* 跑到上面 */
            
            font-size: 56px;
            /* 【修改点3】加粗：从 200 改为 400 */
            font-weight: 350; 
            margin-bottom: 0;
            margin-top: 0;
            /* 【修改点4】不透明度：拉满到 1 */
            opacity: 1;
            color: rgba(255, 255, 255, 1);
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* 翻转时的辅助类：只旋转，不位移 */
        .timer-content.rotate-out {
            transform: perspective(600px) rotateY(90deg);
        }

        /* 底部文字与按钮 */
        .text-area {
            position: absolute;
            bottom: 140px;
            width: 80%;
            text-align: center;
            z-index: 5;
            min-height: 50px;
        }
        .fade-text {
            font-size: 16px;
            line-height: 1.6;
            color: rgba(255,255,255,0.9);
            transition: opacity 1s;
        }
        .fade-text.hidden { opacity: 0; }

        /* --- 底部按钮控制区 --- */
        .controls {
            position: absolute;
            bottom: 80px; /* 稍微往上提一点，留出空间 */
            z-index: 5;
            display: flex;
            gap: 40px; /* 两个按钮之间的间距 */
            justify-content: center;
            width: 100%;
        }

        /* 按钮通用基础样式 */
        .control-btn {
            padding: 12px 40px;    /* 增加左右内边距，使其呈长胶囊状 */
            border-radius: 50px;   /* 大圆角 */
            font-size: 18px;
            cursor: pointer;
            transition: transform 0.1s, opacity 0.2s;
            outline: none;
            letter-spacing: 1px;   /* 字间距稍微拉开一点好看 */
        }

        /* 点击时的按压效果 */
        .control-btn:active {
            transform: scale(0.95);
        }

        /* === 左侧“结束”按钮样式 (白色填充) === */
        .btn-end {
            background-color: #ffffff;
            color: #333333;       /* 深灰色文字 */
            border: 1px solid #ffffff; /* 保持边框一致防止抖动 */
        }

        /* === 右侧“暂停”按钮样式 (透明描边) === */
        .btn-pause {
            background-color: transparent; /* 透明背景 */
            color: #ffffff;                /* 白色文字 */
            border: 1px solid rgba(255, 255, 255, 0.8); /* 半透明白边框 */
        }

        /* --- 历史记录下拉菜单样式 --- */
        .input-wrapper {
            position: relative; /* 确保下拉菜单相对于输入框定位 */
        }

        .history-dropdown {
            position: absolute;
            top: 100%; /* 在输入框正下方 */
            left: 0;
            width: 100%;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            margin-top: 10px;
            padding: 5px 0;
            z-index: 100;
            display: none; /* 默认隐藏 */
            border: 1px solid #eee;
        }

        /* 小三角箭头 */
        .history-dropdown::before {
            content: "";
            position: absolute;
            top: -6px;
            left: 20px;
            width: 12px;
            height: 12px;
            background: white;
            transform: rotate(45deg);
            border-top: 1px solid #eee;
            border-left: 1px solid #eee;
        }

        .history-item {
            padding: 12px 20px;
            font-size: 16px;
            color: #333;
            cursor: pointer;
            transition: background 0.2s;
        }

        .history-item:hover {
            background-color: #f5f5f5;
            color: #2196F3;
        }
    </style>
</head>
<body>

    <!-- ================= 场景 1: 设置页面 ================= -->
    <div id="setup-screen" class="screen active">
        
        <div class="input-group">
            <div class="section-title">本次学习内容</div>
            
            <!-- 新增了一个 relative 定位的包裹层 -->
            <div class="input-wrapper">
                <!-- 注意：加了 autocomplete="off" 防止浏览器自带的历史记录遮挡 -->
                <input type="text" id="task-input" class="clean-input" value="" placeholder="如：背单词..." autocomplete="off">
                
                <!-- 历史记录下拉菜单 -->
                <div id="history-dropdown" class="history-dropdown">
                    <!-- JS 会自动填充内容 -->
                </div>
            </div>
        </div>

        <!-- HTML 修改部分 -->
        <div class="input-group">
            <div class="section-title">设置学习时长</div>
            
            <!-- 点击触发弹窗 -->
            <div class="duration-trigger-row" onclick="openPicker()">
                <!-- 左侧：提示语 -->
                <div class="hint-text" id="end-time-hint">到时会提醒学习结束</div>
                
                <!-- 右侧：数值 + 下划线 -->
                <div class="time-value-wrapper">
                    <!-- 初始显示“未设置”，单位隐藏 -->
                    <span class="duration-display" id="display-hours">未设置</span>
                    <span class="duration-unit" id="display-unit" style="display:none;">小时</span>
                </div>
            </div>
        </div>

        <!-- 底部开始按钮 -->
        <div class="start-btn-container">
            <button class="start-btn" onclick="startFocus()">开始学习</button>
        </div>
    </div>

    <!-- ================= 弹窗: 时间选择器 ================= -->
    <div class="modal-overlay" id="modal-overlay" onclick="closePicker()"></div>
    <div class="picker-modal" id="picker-modal">
        <!-- 顶部工具栏 -->
        <div class="picker-toolbar">
            <button class="toolbar-btn btn-cancel" onclick="closePicker()">取消</button>
            <button class="toolbar-btn btn-confirm" onclick="confirmPicker()">完成</button>
        </div>
        
        <!-- 滚轮主体 -->
        <div class="ios-picker-wrapper">
            <div class="picker-highlight"></div>

            <!-- 小时列 -->
            <div class="picker-column" id="col-hour">
                <div class="picker-content" id="hour-content"></div>
            </div>
            <div class="picker-label-text">小时</div>

            <!-- 分钟列 -->
            <div class="picker-column" id="col-minute">
                <div class="picker-content" id="minute-content"></div>
            </div>
            <div class="picker-label-text">分钟</div>
        </div>
    </div>


    <!-- ================= 场景 2: 计时器页面 ================= -->
    <div id="timer-screen" class="screen">
        <div class="bg-layer" id="bg-layer"></div>
        <div class="overlay"></div>

        <div class="timer-circle">
            <svg viewBox="0 0 300 300">
                <circle class="circle-bg" cx="150" cy="150" r="140"></circle>
                <circle class="circle-progress" id="progress-ring" cx="150" cy="150" r="140"></circle>
            </svg>
            <div class="timer-content">
                <div class="main-time" id="timer-display">00:00:00</div>
                <div class="task-name-display" id="timer-task-name"></div>
            </div>
        </div>

        <div class="text-area">
            <div id="alternating-text" class="fade-text"></div>
        </div>

        <div class="controls">
            <!-- 结束按钮：加了 btn-end 类 -->
            <button class="control-btn btn-end" onclick="confirmEnd()">结束</button>
            
            <!-- 暂停按钮：加了 btn-pause 类 -->
            <button class="control-btn btn-pause" id="pause-btn" onclick="togglePause()">暂停</button>
        </div>
    </div>

    <script>
        // ================= 配置数据 =================
// ================= 配置数据 (本地图片版) =================
        const resources = [
            // --- 第 1 组 ---
            { img: './images/1.png', title: '保持专注', quote: '每一分钟的努力都算数。' },
            { img: './images/2.jpg', title: '心流状态', quote: '沉浸其中，享受过程。' },
            { img: './images/3.jpg', title: '坚持到底', quote: '终点就在前方。' },
            { img: './images/4.jpg', title: '标题4', quote: '这里填入第4张图的文案...' },
            { img: './images/5.jpg', title: '标题5', quote: '这里填入第5张图的文案...' },
            { img: './images/6.jpg', title: '标题6', quote: '这里填入第6张图的文案...' },
            
            // --- 第 2 组 ---
            { img: './images/7.jpg', title: '标题7', quote: '这里填入第7张图的文案...' },
            { img: './images/8.jpg', title: '标题8', quote: '这里填入第8张图的文案...' },
            { img: './images/9.jpg', title: '标题9', quote: '这里填入第9张图的文案...' },
            { img: './images/10.jpg', title: '标题10', quote: '这里填入第10张图的文案...' },
            { img: './images/11.jpg', title: '标题11', quote: '这里填入第11张图的文案...' },
            { img: './images/12.jpg', title: '标题12', quote: '这里填入第12张图的文案...' },

            // --- 第 3 组 ---
            { img: './images/13.jpg', title: '标题13', quote: '这里填入第13张图的文案...' },
            { img: './images/14.jpg', title: '标题14', quote: '这里填入第14张图的文案...' },
            { img: './images/15.jpg', title: '标题15', quote: '这里填入第15张图的文案...' },
            { img: './images/16.jpg', title: '标题16', quote: '这里填入第16张图的文案...' },
            { img: './images/17.jpg', title: '标题17', quote: '这里填入第17张图的文案...' },
            { img: './images/18.jpg', title: '标题18', quote: '这里填入第18张图的文案...' },

            // --- 第 4 组 ---
            { img: './images/19.jpg', title: '标题19', quote: '这里填入第19张图的文案...' },
            { img: './images/20.jpg', title: '标题20', quote: '这里填入第20张图的文案...' },
            { img: './images/21.jpg', title: '标题21', quote: '这里填入第21张图的文案...' },
            { img: './images/22.jpg', title: '标题22', quote: '这里填入第22张图的文案...' },
            { img: './images/23.jpg', title: '标题23', quote: '这里填入第23张图的文案...' },
            { img: './images/24.jpg', title: '标题24', quote: '这里填入第24张图的文案...' }
        ];

        // ================= 全局变量 =================
// ================= 全局变量 =================
        let totalDurationMinutes = 60; // 默认 60 分钟
        
        let isRunning = false;
        let textInterval = null;       // 文字轮播定时器
        let currentResIndex = 0;       // 当前背景/文案索引

        // --- 新增：高精度计时与动画变量 ---
        let startTime = 0;             // 本次开始的时间戳
        let elapsedMs = 0;             // 暂停前积累的毫秒数
        let animationFrameId = null;   // 动画帧 ID (替代 timerInterval)
        let lastCycleIndex = 0;        // 记录当前是第几圈
        
        // --- 旧变量 (已废弃，已删除) ---
        // let timerSeconds = 0; 
        // let timerInterval = null;

        // ================= DOM 元素 =================
        const setupScreen = document.getElementById('setup-screen');
        const timerScreen = document.getElementById('timer-screen');
        
        // Picker 相关
        const pickerModal = document.getElementById('picker-modal');
        const modalOverlay = document.getElementById('modal-overlay');
        const colHour = document.getElementById('col-hour');
        const colMinute = document.getElementById('col-minute');
        const displayHours = document.getElementById('display-hours');
        const endTimeHint = document.getElementById('end-time-hint');

        // Timer 相关
        const timerDisplay = document.getElementById('timer-display');
        const progressRing = document.getElementById('progress-ring');
        const taskNameInput = document.getElementById('task-input');
        const timerTaskName = document.getElementById('timer-task-name');
        const bgLayer = document.getElementById('bg-layer');
        const alternatingText = document.getElementById('alternating-text');
        const pauseBtn = document.getElementById('pause-btn');

        // SVG 设置
        const radius = 140;
        const circumference = 2 * Math.PI * radius;
        progressRing.style.strokeDasharray = `${circumference} ${circumference}`;
        progressRing.style.strokeDashoffset = circumference;

        // ================= 1. Picker 逻辑 (初始化 & 交互) =================
        
        const itemHeight = 44; // 与 CSS 保持一致

        // === 新增：通用的鼠标拖拽滚动函数 ===
        function enableDragScroll(container) {
            let isDown = false;
            let startY;
            let scrollTop;

            container.addEventListener('mousedown', (e) => {
                isDown = true;
                startY = e.pageY;
                scrollTop = container.scrollTop;
                // 拖拽开始时，暂时关闭 CSS 的自动吸附，否则会卡顿
                container.style.scrollSnapType = 'none';
            });

            const stopDrag = () => {
                if (!isDown) return;
                isDown = false;
                // 拖拽结束，恢复 CSS 吸附，让它自动回弹对齐
                container.style.scrollSnapType = 'y mandatory';
            };

            container.addEventListener('mouseleave', stopDrag);
            container.addEventListener('mouseup', stopDrag);

            container.addEventListener('mousemove', (e) => {
                if (!isDown) return;
                e.preventDefault(); // 防止默认的选择行为
                const y = e.pageY;
                const walk = (y - startY) * 1.5; // * 1.5 是为了让拖拽稍微快一点，手感更好
                container.scrollTop = scrollTop - walk;
            });
        }

        function initPicker() {
            // 生成小时 (0-12)
            let hHtml = '<div class="picker-placeholder"></div>';
            for(let i=0; i<=12; i++) hHtml += `<div class="picker-item" data-v="${i}">${i}</div>`;
            hHtml += '<div class="picker-placeholder"></div>';
            document.getElementById('hour-content').innerHTML = hHtml;

            // 生成分钟 (0-59)
            let mHtml = '<div class="picker-placeholder"></div>';
            for(let i=0; i<60; i++) mHtml += `<div class="picker-item" data-v="${i}">${i.toString().padStart(2,'0')}</div>`;
            mHtml += '<div class="picker-placeholder"></div>';
            document.getElementById('minute-content').innerHTML = mHtml;

         // 在 initPicker 函数底部，找到 setTimeout 部分，改为：
        setTimeout(() => {
            // 滚轮还是可以默认停在 1 小时 0 分钟的位置方便用户选
            colHour.scrollTop = 1 * itemHeight;
            colMinute.scrollTop = 0 * itemHeight;
            updateHighlight(colHour);
            updateHighlight(colMinute);
            // 注意：这里不再调用 calculateEndTime，因为初始状态是“未设置”
        }, 100);

            // 绑定滚动高亮事件
            colHour.addEventListener('scroll', () => updateHighlight(colHour));
            colMinute.addEventListener('scroll', () => updateHighlight(colMinute));

            enableDragScroll(colHour);
            enableDragScroll(colMinute);
        }

        function updateHighlight(container) {
            let index = Math.round(container.scrollTop / itemHeight);
            let items = container.querySelectorAll('.picker-item');
            items.forEach((item, i) => {
                if (i === index) {
                    item.style.color = '#333';
                    item.style.fontWeight = 'bold';
                    item.style.transform = 'scale(1.1)';
                } else {
                    item.style.color = '#bbb';
                    item.style.fontWeight = 'normal';
                    item.style.transform = 'scale(1)';
                }
            });
        }

        function getPickerValue() {
            let h = Math.round(colHour.scrollTop / itemHeight);
            let m = Math.round(colMinute.scrollTop / itemHeight);
            return { h, m };
        }

        // 打开弹窗
        function openPicker() {
            modalOverlay.classList.add('open');
            pickerModal.classList.add('open');
        }

        // 关闭弹窗
        function closePicker() {
            modalOverlay.classList.remove('open');
            pickerModal.classList.remove('open');
        }

        // 替换整个 confirmPicker 函数
        function confirmPicker() {
            const { h, m } = getPickerValue();
            const totalMins = h * 60 + m;

            if (totalMins === 0) {
                alert("请至少设置 1 分钟");
                return;
            }

            totalDurationMinutes = totalMins;
            
            // 1. 更新右侧数值显示
            const displayVal = (totalMins / 60).toFixed(1);
            const displayEl = document.getElementById('display-hours');
            const unitEl = document.getElementById('display-unit');
            
            displayEl.innerText = displayVal; // 显示数字
            unitEl.style.display = 'inline';  // 显示“小时”单位

            // 删除或注释掉之前给父容器加线的代码：
            // document.querySelector('.time-value-wrapper').style.borderBottom = '2px solid #2196F3';

            // 改为：给数字元素本身加线，并加一点点底部内边距让线和字不挨太近
            displayEl.style.borderBottom = '2px solid #2196F3';
            displayEl.style.paddingBottom = '4px'; 
            // 2. 更新左侧提示文字颜色和内容
            const hintEl = document.getElementById('end-time-hint');
            hintEl.style.color = '#dba859'; // 变成金/橙色
            
            calculateEndTime(totalMins); // 计算并显示结束时间

            closePicker();
        }

        function calculateEndTime(minutes) {
            const now = new Date();
            const end = new Date(now.getTime() + minutes * 60000);
            const endStr = `${end.getHours().toString().padStart(2,'0')}:${end.getMinutes().toString().padStart(2,'0')}`;
            endTimeHint.innerText = `${endStr} 会暂停且提醒结束计时`;
        }

        // ================= 2. 计时器逻辑 =================

// 1. 开始专注
function startFocus() {
            // 保存历史记录
            if(typeof saveTaskToHistory === 'function') saveTaskToHistory(taskNameInput.value);

            if (totalDurationMinutes <= 0) return alert('请先设置时长');
            
            // 切换界面
            setupScreen.classList.remove('active');
            timerScreen.classList.add('active');
            
            // 获取容器
            const timerContent = document.querySelector('.timer-content');
            
            // 进入初始模式
            timerContent.classList.add('initial-mode');
            
            // 确保没有残留的样式，清空 transform
            timerContent.style.transform = ''; 
            timerContent.classList.remove('rotate-out');

            // 初始化文字
            const userTask = taskNameInput.value || '专注时刻';
            timerTaskName.innerText = userTask; 
            
            // 底部名言先隐藏
            alternatingText.classList.add('hidden'); 
            
            // 重置状态
            elapsedMs = 0; 
            lastCycleIndex = 0;
            updateResource(0, true); 
            
            // 立即开始
            startTimerLogic();
        }

        // 2. 核心计时逻辑 (改为 requestAnimationFrame)
        function startTimerLogic() {
            if (isRunning) return;
            isRunning = true;
            pauseBtn.innerText = "暂停";

            // 记录当前时刻
            startTime = performance.now();

            // 定义每一帧的循环函数
            const loop = () => {
                // 计算当前这一段跑了多久 + 之前积累的时间
                const now = performance.now();
                const currentSessionMs = now - startTime; 
                const totalCurrentMs = elapsedMs + currentSessionMs;

                // 转换为秒（用于显示和判断）
                const totalSeconds = totalCurrentMs / 1000;

                // 更新界面 (传入毫秒实现丝滑)
                updateTimerUI(totalCurrentMs);

                // 检查切图逻辑 (每20分钟 = 1200秒)
                const currentCycle = Math.floor(totalSeconds / 1200);
                if (currentCycle > lastCycleIndex) {
                    lastCycleIndex = currentCycle;
                    // 切图
                    if(typeof currentResIndex !== 'undefined') {
                        currentResIndex++;
                        updateResource(currentResIndex);
                    }
                }

                // 检查结束
                if (totalSeconds >= totalDurationMinutes * 60) {
                    elapsedMs = totalDurationMinutes * 60 * 1000; // 修正为刚好满
                    updateTimerUI(elapsedMs); // 最后刷新一次确保满圈
                    finishTimer();
                    return; // 停止循环
                }

                // 继续下一帧
                if (isRunning) {
                    animationFrameId = requestAnimationFrame(loop);
                }
            };

            // 启动循环
            animationFrameId = requestAnimationFrame(loop);
            
            // 启动文字动画
            if(typeof startTextAnim === 'function') startTextAnim();
        }

        // 3. 界面更新逻辑 (接收毫秒参数)
        function updateTimerUI(currentMs) {
            // --- A. 更新时间文字 (向下取整显示) ---
            const totalSecondsInt = Math.floor(currentMs / 1000);
            const h = Math.floor(totalSecondsInt / 3600);
            const m = Math.floor((totalSecondsInt % 3600) / 60);
            const s = totalSecondsInt % 60;
            timerDisplay.innerText = `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;

            // --- B. 更新进度条 (使用毫秒计算，丝滑无停顿) ---
            const cycleTimeMs = 1200 * 1000; // 20分钟 = 1200000毫秒
            const totalTargetMs = totalDurationMinutes * 60 * 1000;

            // 1. 当前周期的起始毫秒数
            let currentCycleStartMs = Math.floor(currentMs / cycleTimeMs) * cycleTimeMs;
            
            // 2. 计算这一圈的总时长 (毫秒)
            let remainingMsFromCycleStart = totalTargetMs - currentCycleStartMs;
            let currentRingDurationMs;

            if (remainingMsFromCycleStart < cycleTimeMs) {
                // 最后一段不足20分钟
                currentRingDurationMs = remainingMsFromCycleStart;
            } else {
                // 标准20分钟
                currentRingDurationMs = cycleTimeMs;
            }

            // 3. 当前这一圈跑了多少毫秒
            let timeInThisCycleMs = currentMs - currentCycleStartMs;

            // 4. 计算比例
            if (currentRingDurationMs <= 0) currentRingDurationMs = 1;
            let percent = timeInThisCycleMs / currentRingDurationMs;
            if (percent > 1) percent = 1; // 封顶

            // 5. 应用样式
            const offset = circumference - (percent * circumference);
            progressRing.style.strokeDashoffset = offset;
        }

        // 4. 暂停/继续
        function togglePause() {
            if (isRunning) {
                // === 暂停 ===
                isRunning = false;
                pauseBtn.innerText = "继续";
                
                // 停止动画帧
                cancelAnimationFrame(animationFrameId);
                clearInterval(textInterval);

                // 关键：把这段时间跑的毫秒数累加保存
                const now = performance.now();
                elapsedMs += (now - startTime);

            } else {
                // === 继续 ===
                startTimerLogic(); // 重新开始循环，startTime 会被重置为当前
            }
        }

        // 5. 停止/放弃
        function stopTimer() {
            isRunning = false;
            cancelAnimationFrame(animationFrameId);
            clearInterval(textInterval);
            timerScreen.classList.remove('active');
            setupScreen.classList.add('active');
        }

        function stopTimer() {
            clearInterval(timerInterval);
            clearInterval(textInterval);
            isRunning = false;
            timerScreen.classList.remove('active');
            setupScreen.classList.add('active');
        }

        function finishTimer() {
            stopTimer();
            alert('恭喜，专注任务完成！');
        }

        // ================= 3. 背景与文字切换 =================

// 替换 updateResource 函数
        function updateResource(idx, isFirstLoad = false) {
            const data = resources[idx % resources.length];
            
            // 1. 切换背景
            bgLayer.style.backgroundImage = `url('${data.img}')`;
            
            // 2. 如果不是第一次加载（中间自动切图），按正常逻辑淡入淡出
            if (!isFirstLoad) {
                timerTaskName.classList.add('hidden');
                alternatingText.classList.add('hidden');
                setTimeout(() => {
                    timerTaskName.innerText = data.title;
                    alternatingText.innerText = data.quote;
                    timerTaskName.classList.remove('hidden');
                    alternatingText.classList.remove('hidden');
                }, 1000);
            } 
            // 如果是 isFirstLoad (刚开始)，文字由 startFocus 和 startTextAnim 控制，这里不操作
        }

function startTextAnim() {
            if (textInterval) clearInterval(textInterval);

            const data = resources[currentResIndex % resources.length];
            const timerContent = document.querySelector('.timer-content');

            // === 终极防抖翻转序列 ===
            
            // 1. 初始停留
            setTimeout(() => {
                
                // 2. 前半段：匀速转到 90度
                // 注意：这里不需要 translate 了，只操作 rotateY
                timerContent.style.transition = 'transform 0.5s linear';
                timerContent.classList.add('rotate-out');
                
                // 3. 到达中间点
                setTimeout(() => {
                    
                    // A. 隐藏，防止闪烁
                    timerContent.style.opacity = '0';
                    
                    // B. 改变布局和内容
                    timerContent.classList.remove('initial-mode');
                    timerTaskName.innerText = data.title;
                    alternatingText.innerText = data.quote;
                    
                    // C. 瞬间重置位置到 -90度
                    timerContent.style.transition = 'none';
                    // 【重点】这里去掉了 translate(-50%, -50%)
                    timerContent.style.transform = 'perspective(600px) rotateY(-90deg)';
                    timerContent.classList.remove('rotate-out');

                    // D. 强制重绘
                    void timerContent.offsetWidth; 

                    // E. 请求下一帧执行回转
                    requestAnimationFrame(() => {
                        timerContent.style.opacity = '1';
                        timerContent.style.transition = 'transform 0.5s linear';
                        
                        // 【重点】这里也去掉了 translate(-50%, -50%)
                        timerContent.style.transform = 'perspective(600px) rotateY(0deg)';
                        
                        alternatingText.classList.remove('hidden');
                    });
                    
                }, 500); 
                
            }, 1500);


            // === 后续呼吸循环 (不变) ===
            const runBreathingLoop = () => {
                timerTaskName.classList.add('hidden');
                alternatingText.classList.add('hidden');
                setTimeout(() => {
                    if(isRunning) {
                        timerTaskName.classList.remove('hidden');
                        alternatingText.classList.remove('hidden');
                    }
                }, 10000);
            };

            setTimeout(() => {
                if(isRunning) {
                    runBreathingLoop();
                    textInterval = setInterval(runBreathingLoop, 20000);
                }
            }, 10000);
        }

        // ================= 初始化 =================
        initPicker();

        // ================= 历史记录逻辑 =================

        const taskInput = document.getElementById('task-input');
        const historyDropdown = document.getElementById('history-dropdown');

        // 从本地存储获取历史数据 { "任务名": 次数 }
        function getHistory() {
            return JSON.parse(localStorage.getItem('taskHistory')) || {};
        }

        // 渲染下拉菜单
        function showHistoryDropdown() {
            const history = getHistory();
            const list = [];

            // 筛选：只有次数 >= 2 的才显示
            for (let [name, count] of Object.entries(history)) {
                if (count >= 2) {
                    list.push(name);
                }
            }

            // 如果没有符合条件的历史记录，不显示
            if (list.length === 0) {
                historyDropdown.style.display = 'none';
                return;
            }

            // 生成 HTML
            let html = '';
            list.forEach(name => {
                html += `<div class="history-item" onmousedown="selectHistory('${name}')">${name}</div>`;
            });
            historyDropdown.innerHTML = html;
            historyDropdown.style.display = 'block';
        }

        // 选择历史记录
        function selectHistory(name) {
            taskInput.value = name;
            historyDropdown.style.display = 'none';
        }

        // 保存历史记录 (在开始学习时调用)
        function saveTaskToHistory(taskName) {
            if (!taskName.trim()) return; // 空任务不保存
            
            const history = getHistory();
            // 计数 + 1
            if (history[taskName]) {
                history[taskName]++;
            } else {
                history[taskName] = 1;
            }
            localStorage.setItem('taskHistory', JSON.stringify(history));
        }

        // --- 事件监听 ---

        // 1. 输入框获得焦点时：尝试显示历史记录
        taskInput.addEventListener('focus', showHistoryDropdown);

        // 2. 输入框失去焦点时：延迟隐藏（为了让点击事件能先触发）
        taskInput.addEventListener('blur', () => {
            setTimeout(() => {
                historyDropdown.style.display = 'none';
            }, 200);
        });

        // ================= 结束控制逻辑 =================

        // 1. 点击按钮触发的确认函数
        function confirmEnd() {
            // 弹出原生确认框
            const isConfirmed = confirm("确定要结束本次学习吗？");
            
            if (isConfirmed) {
                // 如果用户点“确定”，则执行停止逻辑
                stopTimer();
            }
            // 如果点“取消”，什么都不做，计时继续
        }

        // 2. 停止并返回主页的核心逻辑
        function stopTimer() {
            // 停止运行状态
            isRunning = false;
            
            // 停止所有的计时器和动画帧
            if (animationFrameId) cancelAnimationFrame(animationFrameId);
            if (textInterval) clearInterval(textInterval);
            
            // 切换回设置页面
            timerScreen.classList.remove('active'); // 隐藏计时页
            setupScreen.classList.add('active');    // 显示设置页
            
            // 重置暂停按钮的文字，防止下次进来还是显示“继续”
            if (pauseBtn) pauseBtn.innerText = "暂停";
        }

        // ================= 全屏控制逻辑 =================

        // 监听全局键盘事件
        document.addEventListener('keydown', (e) => {
            // 检测组合键：Shift + Enter
            if (e.shiftKey && e.key === 'Enter') {
                e.preventDefault(); // 防止可能产生的默认换行等行为
                enterFullScreen();
            }
        });

        function enterFullScreen() {
            // 获取文档根元素 (<html>)
            const elem = document.documentElement;

            // 检查当前是否已经是全屏
            if (!document.fullscreenElement) {
                // 兼容不同浏览器的 API
                if (elem.requestFullscreen) {
                    elem.requestFullscreen();
                } else if (elem.webkitRequestFullscreen) { /* Safari */
                    elem.webkitRequestFullscreen();
                } else if (elem.msRequestFullscreen) { /* IE11 */
                    elem.msRequestFullscreen();
                }
            } else {
                // 如果用户想用 Shift+Enter 退出全屏也可以（可选）
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                }
            }
        }
        
        // 监听全屏变化事件（可选：用于调试或后续扩展 UI 变化）
        document.addEventListener('fullscreenchange', () => {
            if (document.fullscreenElement) {
                console.log("已进入全屏沉浸模式");
            } else {
                console.log("已退出全屏");
            }
        });
    </script>
</body>
</html>