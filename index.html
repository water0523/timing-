<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>timingè®¡æ—¶å™¨</title>
    <style>
/* --- å…¨å±€æ ·å¼ & é‡ç½® --- */
        * { 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent; 
            
            /* === æ–°å¢ä»£ç å¼€å§‹ï¼šç¦æ­¢é¡µé¢å˜è“ === */
            user-select: none;          /* æ ‡å‡†è¯­æ³•ï¼šç¦æ­¢é€‰ä¸­ */
            -webkit-user-select: none;  /* Safari/Chrome å…¼å®¹ */
            /* === æ–°å¢ä»£ç ç»“æŸ === */
        }

        /* === å…³é”®ä¿®æ­£ï¼šè¾“å…¥æ¡†å¿…é¡»èƒ½é€‰ä¸­ï¼Œå¦åˆ™æ— æ³•æ‰“å­—ï¼ === */
        input, textarea {
            user-select: text !important;
            -webkit-user-select: text !important;
            /* ä¿æŒè¾“å…¥æ¡†çš„å…‰æ ‡æ­£å¸¸æ˜¾ç¤º */
            cursor: text; 
        }
        body, html {
            margin: 0; padding: 0;
            width: 100%; height: 100%;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            overflow: hidden; /* ç¦æ­¢æ•´ä½“æ»šåŠ¨ */
            background-color: #fff;
            color: #333;
        }

        /* --- åœºæ™¯å®¹å™¨ --- */
        .screen {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            display: none;
            flex-direction: column;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .screen.active {
            display: flex;
            opacity: 1;
            z-index: 10;
        }

        /* ==============================
           åœºæ™¯ 1: è®¾ç½®é¡µé¢ (å¤åˆ»å›¾2ã€å›¾4é£æ ¼)
           ============================== */
        #setup-screen {
            background: #fff;
            padding: 24px;
            position: relative;
        }

        /* æ ‡é¢˜éƒ¨åˆ† */
        .section-title {
            font-size: 20px;
            font-weight: bold;
            color: #333;
            margin-top: 20px;
            margin-bottom: 15px;
        }

        /* è¾“å…¥æ¡†æ ·å¼ */
        .input-group {
            margin-bottom: 40px;
        }

        .clean-input {
            width: 100%;
            padding: 10px 0;
            font-size: 18px;
            border: none;
            border-bottom: 1px solid #eee;
            outline: none;
            color: #555;
            background: transparent;
            border-radius: 0;
        }
        .clean-input::placeholder { color: #ccc; }

       /* --- CSS ä¿®æ”¹éƒ¨åˆ† --- */

        /* å¤–å±‚å®¹å™¨ï¼šè´Ÿè´£å·¦å³å¸ƒå±€ï¼Œå»æ‰äº†åŸæ¥çš„ border-bottom */
        .duration-trigger-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            padding-bottom: 5px;
            cursor: pointer;
            margin-top: 10px;
        }

        /* å·¦ä¾§æç¤ºæ–‡å­— */
        .hint-text {
            font-size: 14px;
            color: #ccc; /* é»˜è®¤ç°è‰²ï¼Œè®¾ç½®åå˜é‡‘/æ©™è‰² */
            margin-bottom: 5px; /*ä¸ºäº†å’Œå³è¾¹å¯¹é½ */
        }

/* æ‰¾åˆ°è¿™ä¸€å—ï¼Œä¿®æ”¹ä¸ºï¼š */
        .time-value-wrapper {
            /* åˆ æ‰æˆ–è€…æ³¨é‡Šæ‰ä¸‹é¢è¿™ä¸€è¡Œï¼Œé»˜è®¤ä¸æ˜¾ç¤ºæ¨ªçº¿ */
            /* border-bottom: 2px solid #2196F3; */ 
            
            padding-bottom: 5px;
            min-width: 60px;
            text-align: right;
        }

        /* æ•°å€¼æ–‡å­—æ ·å¼ */
        .duration-display {
            font-size: 24px;
            font-weight: bold;
            color: #2196F3;
        }
        
        /* å•ä½ï¼ˆå°æ—¶ï¼‰æ ·å¼ */
        .duration-unit {
            font-size: 16px;
            color: #333;
            margin-left: 5px;
            font-weight: normal;
        }

        /* åº•éƒ¨å¼€å§‹æŒ‰é’® */
        .start-btn-container {
            position: absolute;
            bottom: 0; left: 0;
            width: 100%;
        }
        .start-btn {
            width: 100%;
            padding: 20px;
            background: #2196F3;
            color: white;
            font-size: 20px;
            border: none;
            font-weight: bold;
            cursor: pointer;
        }
        .start-btn:active { background: #1976D2; }

        /* ==============================
           å¼¹çª—: iOS æ—¶é—´é€‰æ‹©å™¨ (å¤åˆ»å›¾3)
           ============================== */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.4);
            z-index: 50;
            visibility: hidden;
            opacity: 0;
            transition: all 0.3s;
        }
        .modal-overlay.open {
            visibility: visible;
            opacity: 1;
        }

        .picker-modal {
            position: fixed;
            bottom: 0; left: 0;
            width: 100%;
            background: #f2f2f2;
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
            z-index: 51;
            padding-bottom: 20px;
        }
        .picker-modal.open {
            transform: translateY(0);
        }

        /* å¼¹çª—é¡¶éƒ¨å·¥å…·æ  */
        .picker-toolbar {
            display: flex;
            justify-content: space-between;
            padding: 15px 20px;
            background: #fff;
            border-bottom: 1px solid #ddd;
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
        }
        .toolbar-btn {
            font-size: 16px;
            border: none;
            background: none;
            cursor: pointer;
        }
        .btn-cancel { color: #888; }
        .btn-confirm { color: #2196F3; font-weight: bold; font-size: 18px; }

        /* é€‰æ‹©å™¨å®¹å™¨ */
        .ios-picker-wrapper {
            position: relative;
            width: 100%;
            height: 240px;
            display: flex;
            justify-content: center;
            overflow: hidden;
            background: #f2f2f2;
            /* æ¸å˜é®ç½© */
            mask-image: linear-gradient(to bottom, transparent, black 40%, black 60%, transparent);
            -webkit-mask-image: linear-gradient(to bottom, transparent 5%, black 40%, black 60%, transparent 95%);
        }

        /* é«˜äº®æ¡ */
        .picker-highlight {
            position: absolute;
            top: 50%; left: 0;
            width: 100%; height: 44px;
            margin-top: -22px;
            background: rgba(255,255,255,0.7);
            border-top: 1px solid #ccc;
            border-bottom: 1px solid #ccc;
            pointer-events: none;
            z-index: 0;
        }

/* --- æ‰¾åˆ°è¿™ä¸ªç±»ï¼Œä¿®æ”¹å¦‚ä¸‹ --- */
        .picker-column {
            flex: 1;
            max-width: 100px;
            height: 100%;
            overflow-y: scroll;
            scrollbar-width: none;
            scroll-snap-type: y mandatory; /* è¿™æ˜¯æ»šè½®å’ŒåŸç”Ÿæ»šåŠ¨çš„å¸é™„ */
            padding: 0;
            position: relative;
            z-index: 1;
            text-align: center;
            
            /* === æ–°å¢éƒ¨åˆ†å¼€å§‹ === */
            cursor: grab;       /* é¼ æ ‡æ”¾ä¸Šå»æ˜¾ç¤ºæŠ“å–æ‰‹åŠ¿ */
            user-select: none;  /* ç¦æ­¢æ‹–æ‹½æ—¶é€‰ä¸­æ–‡æœ¬ */
            /* === æ–°å¢éƒ¨åˆ†ç»“æŸ === */
        }

        .picker-column::-webkit-scrollbar { display: none; }
        
        /* === æ–°å¢ï¼šæŒ‰ä¸‹æ—¶æ˜¾ç¤ºâ€œç´§æŠ“â€æ‰‹åŠ¿ === */
        .picker-column:active {
            cursor: grabbing;
        }

        .picker-item {
            height: 44px; /* å¯¹åº” highlight é«˜åº¦ */
            line-height: 44px;
            font-size: 22px;
            color: #999;
            scroll-snap-align: center;
            transition: all 0.2s;
        }
        .picker-placeholder { height: 98px; } /* (240 - 44)/2 */

        .picker-label-text {
            line-height: 240px; /* å‚ç›´å±…ä¸­ */
            font-size: 16px;
            font-weight: bold;
            color: #333;
            margin: 0 10px;
            z-index: 2;
        }

        /* ==============================
           åœºæ™¯ 2: è®¡æ—¶å™¨é¡µé¢ (å…¨å±æ²‰æµ¸)
           ============================== */
        #timer-screen {
            justify-content: center;
            align-items: center;
            color: white;
            background: #000; /* é»˜è®¤é»‘åº•ï¼Œé˜²æ­¢å›¾ç‰‡åŠ è½½å‰çš„ç™½å± */
        }

        /* æ‰¾åˆ° .bg-layerï¼Œæ›¿æ¢ä¸ºä»¥ä¸‹ä»£ç  */
        .bg-layer {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            
            /* å…³é”®ç‚¹1ï¼šå›¾ç‰‡æ”¾å¤§åˆ° 120%ï¼Œè¿™æ ·å·¦å³æ‰æœ‰ç©ºé—´ç§»åŠ¨ */
            background-size: 120% 120%; 
            background-position: center;
            z-index: 0;
            opacity: 0.8;
            transition: background-image 1s ease-in-out;
            
            /* å…³é”®ç‚¹2ï¼šæ—¶é•¿è®¾ä¸º 20sï¼Œé…åˆ alternate (å¾€è¿”) 
               å»ç¨‹ 20s + å›ç¨‹ 20s = 40s ä¸€ä¸ªå¾ªç¯ */
            animation: moveBg 20s linear infinite alternate;
        }

        /* æ‰¾åˆ° @keyframes moveBgï¼Œæ›¿æ¢ä¸ºä»¥ä¸‹ä»£ç  */
        @keyframes moveBg {
            0% { 
                /* æœ€å·¦ä¾§ï¼šå›¾ç‰‡çš„å·¦è¾¹ç¼˜å¯¹é½å±å¹•å·¦è¾¹ç¼˜ */
                background-position: 0% 50%; 
            }
            100% { 
                /* æœ€å³ä¾§ï¼šå›¾ç‰‡çš„å³è¾¹ç¼˜å¯¹é½å±å¹•å³è¾¹ç¼˜ */
                background-position: 100% 50%; 
            }
        }

        .overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.3);
            z-index: 1;
        }

        /* è¿›åº¦ç¯å®¹å™¨ */
        .timer-circle {
            position: relative;
            width: 300px; height: 300px;
            z-index: 5;
        }

        /* å…ˆæŠŠæ—§çš„ä¼ªå…ƒç´ æ³¢çº¹å…³æ‰ï¼Œé˜²æ­¢å†²çª */
        .timer-circle::before,
        .timer-circle::after {
            display: none;
        }

        /* =========================================
           ã€æ–°ç‰ˆæ³¢çº¹æ•ˆæœ - 3å±‚å åŠ ã€‘
           ========================================= */
        
        /* =========================================
           ã€æ–°ç‰ˆæ³¢çº¹æ•ˆæœ - é¡ºåºå¯åŠ¨ã€‘
           ========================================= */
        
        /* æ³¢çº¹é€šç”¨æ ·å¼ */
        .ripple {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            border-radius: 50%;
            
            /* æç»†å®çº¿ */
            border: 1px solid rgba(255, 255, 255, 0.35);
            
            z-index: -1; 
            
            /* å…³é”®ï¼šé»˜è®¤éšè—ï¼Œåªæœ‰è½®åˆ°å®ƒåŠ¨çš„æ—¶å€™æ‰æ˜¾ç¤º */
            opacity: 0; 
            transform: scale(1);
            
            pointer-events: none; 
        }

        /* åŠ¨ç”»å®šä¹‰ï¼šæ—¶é•¿ 4.5s (ä¿è¯åœºä¸Šæœ€å¤š3ä¸ª) */
        .ripple {
            animation: rippleWave 4.5s cubic-bezier(0.25, 0.46, 0.45, 0.94) infinite;
        }

        /* === ä¿®æ”¹ç‚¹ï¼šä½¿ç”¨æ­£å»¶è¿Ÿï¼Œå®ç°â€œä¾æ¬¡å‡ºå‘â€ === */
        
        /* ç¬¬1æ¡ï¼šç«‹å³å¼€å§‹ */
        .ripple.r1 {
            animation-delay: 0s;
        }
        
        /* ç¬¬2æ¡ï¼šç­‰å¾… 1.5ç§’ åå¼€å§‹ */
        .ripple.r2 {
            animation-delay: 1.5s; 
        }
        
        /* ç¬¬3æ¡ï¼šç­‰å¾… 3.0ç§’ åå¼€å§‹ */
        .ripple.r3 {
            animation-delay: 3.0s;
        }

        /* åŠ¨ç”»å…³é”®å¸§ (ä¿æŒä¸å˜) */
        @keyframes rippleWave {
            0% {
                transform: scale(1);
                opacity: 0.6; /* åˆå§‹äº®åº¦ */
            }
            80% {
                opacity: 0;   /* å°¾éƒ¨æ¸éš */
            }
            100% {
                transform: scale(1.6);
                opacity: 0;
            }
        }

        svg { transform: rotate(-90deg); width: 100%; height: 100%; }
        svg { transform: rotate(-90deg); width: 100%; height: 100%; }
        circle { fill: none; stroke-width: 5; stroke-linecap: round; }
        .circle-bg { stroke: rgba(255,255,255,0.2); }
        .circle-progress { 
            stroke: #fff; 
            /* transition: stroke-dashoffset 0.1s linear;  <-- åŠ¡å¿…åˆ æ‰æˆ–æ³¨é‡Šæ‰è¿™ä¸€è¡Œ */
        }

/* --- æ ¸å¿ƒå®¹å™¨ï¼šå¡«æ»¡æ•´ä¸ªåœ†ç›˜ï¼Œä¸å†ä¾èµ– translate å±…ä¸­ --- */
        .timer-content {
            position: absolute;
            top: 0; left: 0;
            width: 100%; 
            height: 100%; /* å¡«æ»¡çˆ¶å®¹å™¨(300x300) */
            
            display: flex;
            flex-direction: column; 
            align-items: center;
            justify-content: center; /* å†…éƒ¨å†…å®¹å±…ä¸­ */
            
            /* åªåšæ—‹è½¬ï¼Œä¸ç§»åŠ¨ä½ç½®ï¼Œæ ¹é™¤æŠ–åŠ¨æº */
            transform: perspective(600px) rotateY(0deg);
            transform-style: preserve-3d;
            backface-visibility: hidden;
            
            /* åŠ¨ç”»è®¾ç½® */
            transition: transform 0.5s linear, opacity 0.1s linear; 
            
            /* ç¡¬ä»¶åŠ é€Ÿ */
            will-change: transform, opacity;
        }

        /* === é»˜è®¤çŠ¶æ€ï¼ˆå›¾2ï¼‰ï¼šæ—¶é—´åœ¨ä¸Šï¼Œä»»åŠ¡åœ¨ä¸‹ === */
        
/* === é»˜è®¤çŠ¶æ€ï¼ˆå›¾2ï¼‰ï¼šæ—¶é—´æ˜¯å¤§å­—ï¼Œæ–‡æ¡ˆæ˜¯å°å­— === */
        
        .main-time {
            /* é»˜è®¤é¡ºåºï¼š1 */
            order: 1;
            
            font-size: 64px;
            /* ã€ä¿®æ”¹ç‚¹1ã€‘åŠ ç²—ï¼šä» 200 æ”¹ä¸º 400 (normal) */
            font-weight: 350; 
            letter-spacing: 2px;
            line-height: 1.2;
            /* ã€ä¿®æ”¹ç‚¹2ã€‘ä¸é€æ˜åº¦ï¼šæ‹‰æ»¡åˆ° 1 */
            color: rgba(255, 255, 255, 1); 
            margin: 0;
            transition: font-size 0.1s;
            /* å¢åŠ ä¸€ç‚¹æ–‡å­—é˜´å½±å¢å¼ºæ¸…æ™°åº¦ */
            text-shadow: 0 2px 4px rgba(0,0,0,0.1); 
        }

/* ä»»åŠ¡åï¼ˆåœ¨å®¹å™¨å†…éƒ¨ï¼‰ */
.task-name-display {
    order: 2;
    font-size: 20px;
    font-weight: 500;
    margin-top: 5px;
    letter-spacing: 1px;
    color: rgba(255,255,255,0.9);
    
    transition: opacity 1.5s ease-in-out, font-size 0.1s; 
    opacity: 1;

    /* === æ–°å¢ï¼šå•è¡Œçœç•¥å·æ ¸å¿ƒä»£ç  === */
    white-space: nowrap;       /* å¼ºåˆ¶ä¸æ¢è¡Œ */
    overflow: hidden;          /* è¶…å‡ºéƒ¨åˆ†éšè— */
    text-overflow: ellipsis;   /* è¶…å‡ºéƒ¨åˆ†æ˜¾ç¤º ... */
    max-width: 80%;            /* é™åˆ¶æœ€å¤§å®½åº¦ä¸ºåœ†åœˆçš„ 80%ï¼Œé˜²æ­¢è´´è¾¹ */
    text-align: center;        /* çŸ­æ–‡æœ¬å±…ä¸­ */
    display: block;            /* ç¡®ä¿å®½åº¦ç”Ÿæ•ˆ */
}
/* æ–°å¢ï¼šä»»åŠ¡åçš„éšè—çŠ¶æ€ */
.task-name-display.hidden {
    opacity: 0;
}

        /* === åˆå§‹æ¨¡å¼ï¼ˆå›¾1ï¼‰ï¼šä»»åŠ¡æ˜¯å¤§å­—ï¼Œæ—¶é—´æ˜¯å°å­— === */
        
        .timer-content.initial-mode .main-time {
            order: 2; /* è·‘åˆ°ä¸‹é¢ */
            
            font-size: 20px;
            font-weight: 350; /* ä¿æŒä¸€è‡´çš„å­—é‡ï¼Œæˆ–è€…ç¨å¾®ç»†ä¸€ç‚¹ */
            letter-spacing: 1px;
            opacity: 0.9;
            margin-top: 10px;
        }

        .timer-content.initial-mode .task-name-display {
            order: 1; /* è·‘åˆ°ä¸Šé¢ */
            
            font-size: 56px;
            /* ã€ä¿®æ”¹ç‚¹3ã€‘åŠ ç²—ï¼šä» 200 æ”¹ä¸º 400 */
            font-weight: 350; 
            margin-bottom: 0;
            margin-top: 0;
            /* ã€ä¿®æ”¹ç‚¹4ã€‘ä¸é€æ˜åº¦ï¼šæ‹‰æ»¡åˆ° 1 */
            opacity: 1;
            color: rgba(255, 255, 255, 1);
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* ç¿»è½¬æ—¶çš„è¾…åŠ©ç±»ï¼šåªæ—‹è½¬ï¼Œä¸ä½ç§» */
        .timer-content.rotate-out {
            transform: perspective(600px) rotateY(90deg);
        }

        /* åº•éƒ¨æ–‡å­—ä¸æŒ‰é’® */
        .text-area {
            position: absolute;
            bottom: 140px;
            width: 80%;
            text-align: center;
            z-index: 5;
            min-height: 50px;
        }
        /* åº•éƒ¨åè¨€å®¹å™¨ */
/* æ‰¾åˆ° .fade-textï¼Œæ›¿æ¢ä¸ºä»¥ä¸‹ä»£ç  */
.fade-text {
    font-size: 16px;
    line-height: 1.6;
    color: rgba(255,255,255,0.9);
    
    /* å…³é”®ï¼šä¸ä»»åŠ¡åå®Œå…¨ä¸€è‡´çš„è¿‡æ¸¡å‚æ•° */
    transition: opacity 1.5s ease-in-out;
    opacity: 1;
}
.fade-text.hidden { opacity: 0; }

        /* --- åº•éƒ¨æŒ‰é’®æ§åˆ¶åŒº --- */
        .controls {
            position: absolute;
            bottom: 80px; /* ç¨å¾®å¾€ä¸Šæä¸€ç‚¹ï¼Œç•™å‡ºç©ºé—´ */
            z-index: 5;
            display: flex;
            gap: 40px; /* ä¸¤ä¸ªæŒ‰é’®ä¹‹é—´çš„é—´è· */
            justify-content: center;
            width: 100%;
        }

        /* æŒ‰é’®é€šç”¨åŸºç¡€æ ·å¼ */
        .control-btn {
            padding: 12px 40px;    /* å¢åŠ å·¦å³å†…è¾¹è·ï¼Œä½¿å…¶å‘ˆé•¿èƒ¶å›ŠçŠ¶ */
            border-radius: 50px;   /* å¤§åœ†è§’ */
            font-size: 18px;
            cursor: pointer;
            transition: transform 0.1s, opacity 0.2s;
            outline: none;
            letter-spacing: 1px;   /* å­—é—´è·ç¨å¾®æ‹‰å¼€ä¸€ç‚¹å¥½çœ‹ */
        }

        /* ç‚¹å‡»æ—¶çš„æŒ‰å‹æ•ˆæœ */
        .control-btn:active {
            transform: scale(0.95);
        }

        /* === å·¦ä¾§â€œç»“æŸâ€æŒ‰é’®æ ·å¼ (ç™½è‰²å¡«å……) === */
        .btn-end {
            background-color: #ffffff;
            color: #333333;       /* æ·±ç°è‰²æ–‡å­— */
            border: 1px solid #ffffff; /* ä¿æŒè¾¹æ¡†ä¸€è‡´é˜²æ­¢æŠ–åŠ¨ */
        }

        /* === å³ä¾§â€œæš‚åœâ€æŒ‰é’®æ ·å¼ (é€æ˜æè¾¹) === */
        .btn-pause {
            background-color: transparent; /* é€æ˜èƒŒæ™¯ */
            color: #ffffff;                /* ç™½è‰²æ–‡å­— */
            border: 1px solid rgba(255, 255, 255, 0.8); /* åŠé€æ˜ç™½è¾¹æ¡† */
        }

        /* --- å†å²è®°å½•ä¸‹æ‹‰èœå•æ ·å¼ --- */
        .input-wrapper {
            position: relative; /* ç¡®ä¿ä¸‹æ‹‰èœå•ç›¸å¯¹äºè¾“å…¥æ¡†å®šä½ */
        }

        .history-dropdown {
            position: absolute;
            top: 100%; /* åœ¨è¾“å…¥æ¡†æ­£ä¸‹æ–¹ */
            left: 0;
            width: 100%;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            margin-top: 10px;
            padding: 5px 0;
            z-index: 100;
            display: none; /* é»˜è®¤éšè— */
            border: 1px solid #eee;
        }

        /* å°ä¸‰è§’ç®­å¤´ */
        .history-dropdown::before {
            content: "";
            position: absolute;
            top: -6px;
            left: 20px;
            width: 12px;
            height: 12px;
            background: white;
            transform: rotate(45deg);
            border-top: 1px solid #eee;
            border-left: 1px solid #eee;
        }

        .history-item {
            padding: 12px 20px;
            font-size: 16px;
            color: #333;
            cursor: pointer;
            transition: background 0.2s;
        }

        .history-item:hover {
            background-color: #f5f5f5;
            color: #2196F3;
        }

/* --- å¼€å‘è€…æ¨¡å¼æ§ä»¶æ ·å¼ (ä¿®æ”¹ç‰ˆï¼šé¡¶éƒ¨æ‚¬æµ®) --- */
.dev-controls {
    position: absolute;
    /* æ”¹ä¸ºé¡¶éƒ¨å®šä½ */
    top: 60px;  /* ç•™å‡º 60px è·ç¦»ï¼Œé¿å¼€æ‰‹æœºåˆ˜æµ·æˆ–çŠ¶æ€æ  */
    left: 50%;  /* æ°´å¹³å±…ä¸­èµ·å§‹ç‚¹ */
    transform: translateX(-50%); /* ä¿®æ­£æ°´å¹³å±…ä¸­ */
    
    width: 90%;
    z-index: 100; /* æœ€é«˜çš„å±‚çº§ï¼Œä¿è¯èƒ½ç‚¹åˆ° */
    
    text-align: center;
    background: rgba(0, 0, 0, 0.6); /*ç¨å¾®åŠ æ·±ä¸€ç‚¹èƒŒæ™¯ï¼Œä¿è¯åœ¨äº®è‰²å¤©ç©ºèƒŒæ™¯ä¸‹ä¹Ÿèƒ½çœ‹æ¸…*/
    padding: 12px;
    border-radius: 12px;
    backdrop-filter: blur(8px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.3); /* åŠ ä¸€ç‚¹é˜´å½±æ›´æœ‰æ‚¬æµ®æ„Ÿ */
    
    /* é»˜è®¤éšè— */
    display: none; 
}

/* é‡Œé¢çš„å…¶ä»–æ ·å¼ (.dev-header, .dev-label ç­‰) ä¸éœ€è¦åŠ¨ï¼Œä¿æŒåŸæ ·å³å¯ */

/* --- æ–°å¢æ ·å¼ï¼Œæ”¾åœ¨ .dev-controls åé¢ --- */

.dev-header {
    display: flex;
    justify-content: space-between; /* ä¸¤ç«¯å¯¹é½ */
    align-items: center;
    margin-bottom: 8px;
}

/* è¦†ç›–ä¹‹å‰çš„ .dev-label æ ·å¼ï¼Œå»æ‰ margin-bottom å› ä¸ºçˆ¶çº§æ§åˆ¶äº† */
.dev-label {
    color: #00ff00;
    font-size: 12px;
    font-family: monospace;
    text-align: left;
    margin: 0;
}

/* å…³é—­æŒ‰é’®æ ·å¼ */
.dev-close {
    color: #ff4444; /* è­¦ç¤ºçº¢ */
    font-size: 24px;
    line-height: 1;
    cursor: pointer;
    font-weight: bold;
    padding: 0 5px;
    user-select: none;
}
.dev-close:hover {
    color: #ff0000;
    transform: scale(1.2);
}

.dev-label {
    color: #00ff00; /* éª‡å®¢ç»¿ï¼Œä½“ç°å¼€å‘è€…æ¨¡å¼ */
    font-size: 12px;
    margin-bottom: 5px;
    font-family: monospace;
    text-align: left;
}

#dev-slider {
    width: 100%;
    cursor: pointer;
    accent-color: #00ff00; /* æ»‘å—é¢œè‰² */
}

/* --- é€šç”¨å±…ä¸­å¼¹çª—æ ·å¼ --- */
.center-modal {
    position: fixed;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%) scale(0.9);
    background: white;
    width: 85%;
    max-width: 400px;
    border-radius: 16px;
    padding: 24px;
    z-index: 200;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
}
.center-modal.active {
    opacity: 1;
    visibility: visible;
    transform: translate(-50%, -50%) scale(1);
}
.wide-modal { max-width: 600px; }

.modal-title { font-size: 20px; font-weight: bold; margin-bottom: 10px; color: #333; }
.modal-info { font-size: 16px; color: #666; margin-bottom: 20px; }

.modal-header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
.close-icon { font-size: 24px; cursor: pointer; color: #999; padding: 5px; }

/* æ–‡æœ¬åŸŸ */
.clean-textarea {
    width: 100%;
    height: 100px;
    padding: 10px;
    border: 1px solid #eee;
    background: #f9f9f9;
    border-radius: 8px;
    resize: none;
    font-family: inherit;
    font-size: 14px;
    outline: none;
}
.clean-textarea:focus { border-color: #2196F3; background: #fff; }

/* æŒ‰é’®ç»„ */
.modal-btns { display: flex; gap: 10px; justify-content: flex-end; margin-top: 10px; }
.btn-cancel-flat { background: #f5f5f5; color: #666; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; }
.btn-confirm-flat { background: #2196F3; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; }
.full-width { width: 100%; }

/* å†å²åˆ—è¡¨ */
.history-list-container {
    max-height: 300px;
    overflow-y: auto;
    margin-bottom: 15px;
    border-top: 1px solid #eee;
}
.history-row {
    padding: 12px 0;
    border-bottom: 1px solid #eee;
    font-size: 14px;
}
.history-row-top { display: flex; justify-content: space-between; margin-bottom: 4px; font-weight: bold; color: #333; }
.history-row-mid { display: flex; justify-content: space-between; color: #888; font-size: 12px; }
.history-note { margin-top: 6px; background: #f0f8ff; padding: 6px; border-radius: 4px; color: #555; font-size: 13px; }
.empty-tip { text-align: center; padding: 30px; color: #999; }

/* --- ä¼˜åŒ–ï¼šåˆ é™¤æŒ‰é’®æ ·å¼ --- */

/* 1. ä¸“æ³¨å†å²åˆ—è¡¨çš„åˆ é™¤æŒ‰é’® */
.history-row {
    position: relative; /* ä¸ºäº†å®šä½åˆ é™¤æŒ‰é’® */
    padding-right: 30px; /* ç•™å‡ºå³è¾¹ç©ºé—´ç»™åˆ é™¤æŒ‰é’® */
}
.btn-delete-record {
    position: absolute;
    top: 12px;
    right: 5px;
    width: 20px;
    height: 20px;
    line-height: 20px;
    text-align: center;
    color: #ccc;
    cursor: pointer;
    font-size: 18px;
    font-weight: bold;
    border-radius: 50%;
    transition: all 0.2s;
}
.btn-delete-record:hover {
    background: #ffebee; /* æµ…çº¢èƒŒæ™¯ */
    color: #f44336;      /* çº¢è‰²æ–‡å­— */
}

/* 2. è¾“å…¥æ¡†ä¸‹æ‹‰èœå•çš„å¸ƒå±€ä¼˜åŒ– */
.history-item {
    display: flex; /* æ”¹ä¸ºå¼¹æ€§å¸ƒå±€ */
    justify-content: space-between; /* ä¸¤ç«¯å¯¹é½ */
    align-items: center;
    padding: 0; /* æ¸…é™¤åŸæœ‰ paddingï¼Œæ”¹åœ¨å†…éƒ¨å…ƒç´ ä¸Š */
}

/* å·¦ä¾§æ–‡å­—åŒºåŸŸï¼šå æ»¡å‰©ä½™ç©ºé—´ï¼Œå¯ç‚¹å‡» */
.history-item-text {
    flex: 1; 
    padding: 12px 20px;
    cursor: pointer;
}
.history-item-text:hover {
    color: #2196F3; /* ä¿æŒåŸæœ‰çš„æ‚¬åœå˜è‰² */
}

/* å³ä¾§åˆ é™¤æŒ‰é’® */
.history-item-del {
    padding: 12px 15px;
    color: #ddd;
    cursor: pointer;
    font-size: 16px;
    font-weight: bold;
}
.history-item-del:hover {
    color: #f44336; /* æ‚¬åœå˜çº¢ */
    background: #fafafa;
}
    </style>
</head>
<body>

    <!-- ================= åœºæ™¯ 1: è®¾ç½®é¡µé¢ ================= -->
    <div id="setup-screen" class="screen active">
        
        <div class="input-group">
            <div class="section-title">æœ¬æ¬¡å­¦ä¹ å†…å®¹</div>
            
            <!-- æ–°å¢äº†ä¸€ä¸ª relative å®šä½çš„åŒ…è£¹å±‚ -->
            <div class="input-wrapper">
                <!-- æ³¨æ„ï¼šåŠ äº† autocomplete="off" é˜²æ­¢æµè§ˆå™¨è‡ªå¸¦çš„å†å²è®°å½•é®æŒ¡ -->
                <input type="text" id="task-input" class="clean-input" value="" placeholder="å¦‚ï¼šèƒŒå•è¯..." autocomplete="off">
                
                <!-- å†å²è®°å½•ä¸‹æ‹‰èœå• -->
                <div id="history-dropdown" class="history-dropdown">
                    <!-- JS ä¼šè‡ªåŠ¨å¡«å……å†…å®¹ -->
                </div>
            </div>
        </div>

        <!-- HTML ä¿®æ”¹éƒ¨åˆ† -->
        <div class="input-group">
            <div class="section-title">è®¾ç½®å­¦ä¹ æ—¶é•¿</div>
            
            <!-- ç‚¹å‡»è§¦å‘å¼¹çª— -->
            <div class="duration-trigger-row" onclick="openPicker()">
                <!-- å·¦ä¾§ï¼šæç¤ºè¯­ -->
                <div class="hint-text" id="end-time-hint">åˆ°æ—¶ä¼šæé†’å­¦ä¹ ç»“æŸ</div>
                
                <!-- å³ä¾§ï¼šæ•°å€¼ + ä¸‹åˆ’çº¿ -->
                <div class="time-value-wrapper">
                    <!-- åˆå§‹æ˜¾ç¤ºâ€œæœªè®¾ç½®â€ï¼Œå•ä½éšè— -->
                    <span class="duration-display" id="display-hours">æœªè®¾ç½®</span>
                    <span class="duration-unit" id="display-unit" style="display:none;">å°æ—¶</span>
                </div>
            </div>
        </div>

        <div style="text-align: center; margin-bottom: 20px; margin-top: 10px;">
    <span onclick="openHistoryModal()" style="color: #2196F3; cursor: pointer; font-size: 14px; text-decoration: underline;">
        æŸ¥çœ‹å†å²è®°å½•
    </span>
        </div>
        <!-- åº•éƒ¨å¼€å§‹æŒ‰é’® -->
        <div class="start-btn-container">
            <button class="start-btn" onclick="startFocus()">å¼€å§‹å­¦ä¹ </button>
        </div>
    </div>

    <!-- ================= å¼¹çª—: æ—¶é—´é€‰æ‹©å™¨ ================= -->
    <div class="modal-overlay" id="modal-overlay" onclick="closePicker()"></div>
    <div class="picker-modal" id="picker-modal">
        <!-- é¡¶éƒ¨å·¥å…·æ  -->
        <div class="picker-toolbar">
            <button class="toolbar-btn btn-cancel" onclick="closePicker()">å–æ¶ˆ</button>
            <button class="toolbar-btn btn-confirm" onclick="confirmPicker()">å®Œæˆ</button>
        </div>
        
        <!-- æ»šè½®ä¸»ä½“ -->
        <div class="ios-picker-wrapper">
            <div class="picker-highlight"></div>

            <!-- å°æ—¶åˆ— -->
            <div class="picker-column" id="col-hour">
                <div class="picker-content" id="hour-content"></div>
            </div>
            <div class="picker-label-text">å°æ—¶</div>

            <!-- åˆ†é’Ÿåˆ— -->
            <div class="picker-column" id="col-minute">
                <div class="picker-content" id="minute-content"></div>
            </div>
            <div class="picker-label-text">åˆ†é’Ÿ</div>
        </div>
    </div>


    <!-- ================= åœºæ™¯ 2: è®¡æ—¶å™¨é¡µé¢ ================= -->
    <div id="timer-screen" class="screen">
        <div class="bg-layer" id="bg-layer"></div>
        <div class="overlay"></div>

<div class="timer-circle">
    <svg viewBox="0 0 300 300">
        <circle class="circle-bg" cx="150" cy="150" r="140"></circle>
        <circle class="circle-progress" id="progress-ring" cx="150" cy="150" r="140"></circle>
    </svg>
    <div class="timer-content">
        <div class="main-time" id="timer-display">00:00:00</div>
        <div class="task-name-display" id="timer-task-name"></div>
    </div>
    
    <div class="ripple r1"></div>
    <div class="ripple r2"></div>
    <div class="ripple r3"></div>
</div>

        <div class="text-area">
            <div id="alternating-text" class="fade-text"></div>
        </div>
        <!-- å¼€å‘è€…æ¨¡å¼æ—¶é—´è½´ (é»˜è®¤éšè—) -->
<!-- æ‰¾åˆ°ä¹‹å‰çš„ dev-timeline-containerï¼Œæ›¿æ¢ä¸ºä»¥ä¸‹ä»£ç  -->
<div id="dev-timeline-container" class="dev-controls" style="display: none;">
    <!-- é¡¶éƒ¨æ ï¼šå·¦è¾¹æ˜¯æ–‡å­—ï¼Œå³è¾¹æ˜¯å…³é—­æŒ‰é’® -->
    <div class="dev-header">
        <div class="dev-label">waterä¸æ˜¯æ°´ (æ¬£èµæ¨¡å¼)</div>
        <div class="dev-close" onclick="exitDevMode()">Ã—</div>
    </div>
    
    <input type="range" id="dev-slider" min="0" max="28800" step="1" value="0">
</div>
        <div class="controls">
            <!-- ç»“æŸæŒ‰é’®ï¼šåŠ äº† btn-end ç±» -->
            <button class="control-btn btn-end" onclick="confirmEnd()">ç»“æŸ</button>
            
            <!-- æš‚åœæŒ‰é’®ï¼šåŠ äº† btn-pause ç±» -->
            <button class="control-btn btn-pause" id="pause-btn" onclick="togglePause()">æš‚åœ</button>
        </div>
    </div>

    <!-- ================= å¼¹çª—: ç»“æŸæ€»ç»“ (å†™å¤‡æ³¨) ================= -->
<div class="modal-overlay" id="summary-overlay"></div>
<div class="center-modal" id="summary-modal">
    <div class="modal-title">æœ¬æ¬¡ä¸“æ³¨å·²ç»“æŸ</div>
    <div class="modal-info">æ—¶é•¿ï¼š<span id="summary-duration">00:00:00</span></div>
    
    <div class="input-group" style="margin-bottom: 15px;">
        <textarea id="summary-note" class="clean-textarea" placeholder="è®°å½•ä¸€ä¸‹åˆšæ‰çš„æ”¶è·æˆ–æƒ³æ³•..."></textarea>
    </div>

    <div class="modal-btns">
        <button class="btn-cancel-flat" onclick="closeSummary(false)">ä¸ä¿å­˜</button>
        <button class="btn-confirm-flat" onclick="saveAndExit()">ä¿å­˜è®°å½•</button>
    </div>
</div>

<!-- ================= å¼¹çª—: å†å²è®°å½•åˆ—è¡¨ ================= -->
<div class="modal-overlay" id="history-overlay" onclick="closeHistoryModal()"></div>
<div class="center-modal wide-modal" id="history-modal">
    <div class="modal-header-row">
        <div class="modal-title">ä¸“æ³¨å†å²</div>
        <div class="close-icon" onclick="closeHistoryModal()">Ã—</div>
    </div>

    <div class="history-list-container" id="history-list-content">
        <!-- JS åŠ¨æ€å¡«å…… -->
    </div>

    <div class="modal-btns" style="flex-wrap: wrap; gap: 10px;">
        <button class="btn-confirm-flat full-width" onclick="exportToExcel()">å¯¼å‡ºä¸º Excel (è¡¨æ ¼)</button>
        
        <div style="display: flex; gap: 10px; width: 100%;">
            <button class="btn-cancel-flat" style="flex: 1;" onclick="exportBackup()">
                ğŸ“¤ å¯¼å‡ºå¤‡ä»½
            </button>
            <button class="btn-confirm-flat" style="flex: 1; background: #4CAF50;" onclick="triggerImport()">
                ğŸ“¥ å¯¼å…¥å¤‡ä»½
            </button>
        </div>
        
        <input type="file" id="backup-file-input" accept=".json" style="display: none;" onchange="importBackup(this)">
    </div>
</div>
    <script>
        // ================= é…ç½®æ•°æ® =================
// ================= é…ç½®æ•°æ® (æœ¬åœ°å›¾ç‰‡ç‰ˆ) =================
const resources = [
            // --- ç¬¬ 1 ç»„ï¼šå®‡å®™ä¸åœ°çƒèµ·æº ---
            { img: './images/1.png', title: 'å¤§çˆ†ç‚¸', quote: 'å®‡å®™ç”±è¿™ä¸€åˆ»è¯ç”Ÿï¼Œä½ çš„å¾ç¨‹ä¹Ÿç”±æ­¤å¼€å§‹ã€‚' },
            { img: './images/2.png', title: 'å¤ªé˜³ç³»', quote: 'å¤ªé˜³ç³»æ­£åœ¨æ…¢æ…¢å½¢æˆï¼Œä¸‡äº‹å¼€å¤´éš¾ã€‚' },
            { img: './images/3.png', title: 'åœ°çƒå½¢æˆ', quote: 'å­•è‚²ç”Ÿå‘½çš„æ‘‡ç¯®ï¼Œä¼¼ä¹æœ‰çµæ„Ÿæ¶Œä¸Šå¿ƒå¤´ï¼Ÿ' },
            { img: './images/4.png', title: 'å¤ªå¤ä»£', quote: 'ç¬¬ä¸€ä¸ªç”Ÿå‘½è¯ç”Ÿäº†ï¼Œæ˜¯å¦å¾—åˆ°äº†æŸç§å¯å‘å‘¢ï¼Ÿ' },
            { img: './images/5.png', title: 'éœ‡æ—¦çºª', quote: 'è¿›åŒ–æ˜¯æœ€ä¼Ÿå¤§çš„é¦ˆèµ ï¼Œåœ¨ä¸çŸ¥ä¸è§‰ä¸­ï¼Œä½ æ­£åœ¨æ„Ÿå—è¿›æ­¥ã€‚' },
            { img: './images/6.png', title: 'å¯’æ­¦çºª', quote: 'é±¼ç±»æœ€æ´»è·ƒçš„æ—¶æœŸï¼Œé±¼å„¿æ°´ä¸­æ¸¸ï¼Œæ—¶å…‰ä¸€å»ä¸å›å¤´ã€‚' },
            
            // --- ç¬¬ 2 ç»„ï¼šå¤ç”Ÿç‰©æ¼”åŒ– ---
            { img: './images/7.png', title: 'å¥¥é™¶çºª', quote: 'å¤§é™†æ¿å—å½¢æˆï¼Œæ›´å¤§çš„æŒ‘æˆ˜å³å°†æ¥ä¸´ã€‚' },
            { img: './images/8.png', title: 'æ³¥ç›†çºª', quote: 'é™†åœ°çš„æ„Ÿè§‰å¥½å—ï¼Ÿè¯·æŠ“ç´§æ¯ä¸€åˆ†é’Ÿã€‚' },
            { img: './images/9.png', title: 'çŸ³ç‚­çºª', quote: 'ç«å±±å¼€å§‹å–·å‘ï¼Œå¤§å‹çˆ¬è¡ŒåŠ¨ç‰©è¯ç”Ÿäº†ï¼Œæ˜¯å¦æœ‰æ‰€æ”¶è·äº†ï¼Ÿ' },
            { img: './images/10.png', title: 'ä¸‰å çºª', quote: 'å±±å³°ä¸›æ—å¼€å§‹å½¢æˆï¼Œæ³¨æ„é™å¿ƒã€‚' },
            { img: './images/11.png', title: 'ä¾ç½—çºª', quote: 'æé¾™æ¨ªè¡Œçš„å¹´ä»£ï¼Œä¿æŒä¸“æ³¨ï¼Œå…‹æœéš¾å…³ã€‚' },
            { img: './images/12.jpg', title: 'ç™½å©çºª', quote: 'æé¾™ç­ç»ï¼Œç°åœ¨å¯ä»¥å‘Šä¸€æ®µè½äº†ã€‚' },

            // --- ç¬¬ 3 ç»„ï¼šäººç±»æ–‡æ˜å‘å±• ---
            { img: './images/13.png', title: 'å¤ä»£', quote: 'äººç±»çš„ç¥–å…ˆåœ¨è¿™ç¯‡å¤§é™†ä¸Šå¼€ç–†è¾ŸåœŸï¼Œå­¦ä¹ æœ‰æ—¶å€™éœ€è¦äº’ç›¸å¸®åŠ©ã€‚' },
            { img: './images/14.png', title: 'éƒ¨è½', quote: 'å¬è¯´å°ç¬¬å®‰äººå§‹ç»ˆä¿æŒç€è¿™æ ·çš„ç”Ÿæ´»æ–¹å¼ï¼Œä»Šå¤©çš„å­¦ä¹ åˆ°è¿™é‡Œä¹Ÿå¯ä»¥ç»“æŸäº†ã€‚' },
            { img: './images/15.png', title: 'æ‘åº„', quote: 'äººç±»ä¸å†åˆ°å¤„æ¸¸è¡ï¼Œæœ‰äº†è‡ªå·±å›ºå®šçš„â€œå®¶â€ï¼Œè®°å¾—å›å¿†å’Œå·©å›ºè‡ªå·±ä»Šå¤©çš„å­¦ä¹ ã€‚' },
            { img: './images/16.png', title: 'äººç¾¤', quote: 'äººå¤šåŠ›é‡å¤§ï¼Ÿå‰ææ˜¯è¦æœ‰ç€å…±åŒçš„ç›®æ ‡ã€‚' },
            { img: './images/17.png', title: 'è¿‘ä»£', quote: 'ç‹å›½ï¼Œæœä»£é€æ¸å½¢æˆï¼Œæ³¨æ„å½’çº³ä½ æ‰€å­¦çš„çŸ¥è¯†ã€‚' },
            { img: './images/18.png', title: 'ç°ä»£', quote: 'æˆ‘ä»¬æ‰€ç”Ÿæ´»çš„å¹´ä»£ï¼Œæ³¨æ„åŠ³é€¸ç»“åˆã€‚' },

            // --- ç¬¬ 4 ç»„ï¼šæœªæ¥ä¸ç»ˆç»“ ---
            { img: './images/19.png', title: 'åŸå¸‚', quote: 'ç¹è£æ—¶æœŸï¼Œå»åšåšåˆ«çš„äº‹æƒ…å§ã€‚' },
            { img: './images/20.png', title: 'æœªæ¥åŸå¸‚', quote: 'äººç±»ç§‘æŠ€çš„å·…å³°ï¼Œæ¯å¤©çš„çŸ¥è¯†è·å–é‡æ˜¯æœ‰é™çš„ã€‚' },
            { img: './images/21.png', title: 'æ ¸çˆ†ç‚¸', quote: 'ç‰©æå¿…åï¼Œäººç±»å¦‚æ­¤ï¼Œå­¦ä¹ ä¹Ÿæ˜¯å¦‚æ­¤ã€‚' },
            { img: './images/22.png', title: 'åœ°çƒæ¯ç­', quote: 'ä¸–ç•Œçš„å°½å¤´ï¼Œå®ƒå¿…å°†å‘ç”Ÿã€‚è¿‡åº¦çš„å­¦ä¹ ï¼Œä¼šå½±å“çŸ­æœŸè®°å¿†ã€‚' },
            { img: './images/23.png', title: 'å¤ªé˜³æ¯ç­', quote: 'ç”Ÿå‘½è¿¹è±¡æ¶ˆå¤±ï¼Œè¿›å…¥æ•ˆç‡ä½ä¸‹æœŸã€‚' },
            { img: './images/24.png', title: 'å®‡å®™æ¯ç­', quote: 'ç”Ÿå‘½è¿¹è±¡æ¶ˆå¤±ï¼Œè¿›å…¥æ•ˆç‡ä½ä¸‹æœŸã€‚' }
        ];

        // ================= å…¨å±€å˜é‡ =================
// ================= å…¨å±€å˜é‡ =================
        let totalDurationMinutes = 60; // é»˜è®¤ 60 åˆ†é’Ÿ
        
        let isRunning = false;
        let sessionStartTimeObj = null; // è®°å½•å…·ä½“çš„å¼€å§‹æ—¥æœŸæ—¶é—´å¯¹è±¡
        let textInterval = null;       // æ–‡å­—è½®æ’­å®šæ—¶å™¨
        let currentResIndex = 0;       // å½“å‰èƒŒæ™¯/æ–‡æ¡ˆç´¢å¼•
// å…¨å±€åŠ¨ç”»å®šæ—¶å™¨ ID å­˜å‚¨æ± 
let animTimeout1 = null;
let animTimeout2 = null;
let animTimeout3 = null;
let breatheStartTimeout = null; // ç”¨äº10ç§’åå¯åŠ¨å‘¼å¸çš„å»¶æ—¶
let dragDebounceTimer = null;   // ç”¨äºåˆ¤æ–­æ»‘å—ä½•æ—¶åœæ­¢
        // --- æ–°å¢ï¼šé«˜ç²¾åº¦è®¡æ—¶ä¸åŠ¨ç”»å˜é‡ ---
        let startTime = 0;             // æœ¬æ¬¡å¼€å§‹çš„æ—¶é—´æˆ³
        let elapsedMs = 0;             // æš‚åœå‰ç§¯ç´¯çš„æ¯«ç§’æ•°
        let animationFrameId = null;   // åŠ¨ç”»å¸§ ID (æ›¿ä»£ timerInterval)
        let lastCycleIndex = 0;        // è®°å½•å½“å‰æ˜¯ç¬¬å‡ åœˆ
        
        // --- æ—§å˜é‡ (å·²åºŸå¼ƒï¼Œå·²åˆ é™¤) ---
        // let timerSeconds = 0; 
        // let timerInterval = null;

        // ================= DOM å…ƒç´  =================
        const setupScreen = document.getElementById('setup-screen');
        const timerScreen = document.getElementById('timer-screen');
        
        // Picker ç›¸å…³
        const pickerModal = document.getElementById('picker-modal');
        const modalOverlay = document.getElementById('modal-overlay');
        const colHour = document.getElementById('col-hour');
        const colMinute = document.getElementById('col-minute');
        const displayHours = document.getElementById('display-hours');
        const endTimeHint = document.getElementById('end-time-hint');

        // Timer ç›¸å…³
        const timerDisplay = document.getElementById('timer-display');
        const progressRing = document.getElementById('progress-ring');
        const taskNameInput = document.getElementById('task-input');
        const timerTaskName = document.getElementById('timer-task-name');
        const bgLayer = document.getElementById('bg-layer');
        const alternatingText = document.getElementById('alternating-text');
        const pauseBtn = document.getElementById('pause-btn');

        // SVG è®¾ç½®
        const radius = 140;
        const circumference = 2 * Math.PI * radius;
        progressRing.style.strokeDasharray = `${circumference} ${circumference}`;
        progressRing.style.strokeDashoffset = circumference;

        // ================= 1. Picker é€»è¾‘ (åˆå§‹åŒ– & äº¤äº’) =================
        
        const itemHeight = 44; // ä¸ CSS ä¿æŒä¸€è‡´

        // === æ–°å¢ï¼šé€šç”¨çš„é¼ æ ‡æ‹–æ‹½æ»šåŠ¨å‡½æ•° ===
        function enableDragScroll(container) {
            let isDown = false;
            let startY;
            let scrollTop;

            container.addEventListener('mousedown', (e) => {
                isDown = true;
                startY = e.pageY;
                scrollTop = container.scrollTop;
                // æ‹–æ‹½å¼€å§‹æ—¶ï¼Œæš‚æ—¶å…³é—­ CSS çš„è‡ªåŠ¨å¸é™„ï¼Œå¦åˆ™ä¼šå¡é¡¿
                container.style.scrollSnapType = 'none';
            });

            const stopDrag = () => {
                if (!isDown) return;
                isDown = false;
                // æ‹–æ‹½ç»“æŸï¼Œæ¢å¤ CSS å¸é™„ï¼Œè®©å®ƒè‡ªåŠ¨å›å¼¹å¯¹é½
                container.style.scrollSnapType = 'y mandatory';
            };

            container.addEventListener('mouseleave', stopDrag);
            container.addEventListener('mouseup', stopDrag);

            container.addEventListener('mousemove', (e) => {
                if (!isDown) return;
                e.preventDefault(); // é˜²æ­¢é»˜è®¤çš„é€‰æ‹©è¡Œä¸º
                const y = e.pageY;
                const walk = (y - startY) * 1.5; // * 1.5 æ˜¯ä¸ºäº†è®©æ‹–æ‹½ç¨å¾®å¿«ä¸€ç‚¹ï¼Œæ‰‹æ„Ÿæ›´å¥½
                container.scrollTop = scrollTop - walk;
            });
        }

        function initPicker() {
            // ç”Ÿæˆå°æ—¶ (0-12)
            let hHtml = '<div class="picker-placeholder"></div>';
            for(let i=0; i<=12; i++) hHtml += `<div class="picker-item" data-v="${i}">${i}</div>`;
            hHtml += '<div class="picker-placeholder"></div>';
            document.getElementById('hour-content').innerHTML = hHtml;

            // ç”Ÿæˆåˆ†é’Ÿ (0-59)
            let mHtml = '<div class="picker-placeholder"></div>';
            for(let i=0; i<60; i++) mHtml += `<div class="picker-item" data-v="${i}">${i.toString().padStart(2,'0')}</div>`;
            mHtml += '<div class="picker-placeholder"></div>';
            document.getElementById('minute-content').innerHTML = mHtml;

         // åœ¨ initPicker å‡½æ•°åº•éƒ¨ï¼Œæ‰¾åˆ° setTimeout éƒ¨åˆ†ï¼Œæ”¹ä¸ºï¼š
        setTimeout(() => {
            // æ»šè½®è¿˜æ˜¯å¯ä»¥é»˜è®¤åœåœ¨ 1 å°æ—¶ 0 åˆ†é’Ÿçš„ä½ç½®æ–¹ä¾¿ç”¨æˆ·é€‰
            colHour.scrollTop = 1 * itemHeight;
            colMinute.scrollTop = 0 * itemHeight;
            updateHighlight(colHour);
            updateHighlight(colMinute);
            // æ³¨æ„ï¼šè¿™é‡Œä¸å†è°ƒç”¨ calculateEndTimeï¼Œå› ä¸ºåˆå§‹çŠ¶æ€æ˜¯â€œæœªè®¾ç½®â€
        }, 100);

            // ç»‘å®šæ»šåŠ¨é«˜äº®äº‹ä»¶
            colHour.addEventListener('scroll', () => updateHighlight(colHour));
            colMinute.addEventListener('scroll', () => updateHighlight(colMinute));

            enableDragScroll(colHour);
            enableDragScroll(colMinute);
        }

        function updateHighlight(container) {
            let index = Math.round(container.scrollTop / itemHeight);
            let items = container.querySelectorAll('.picker-item');
            items.forEach((item, i) => {
                if (i === index) {
                    item.style.color = '#333';
                    item.style.fontWeight = 'bold';
                    item.style.transform = 'scale(1.1)';
                } else {
                    item.style.color = '#bbb';
                    item.style.fontWeight = 'normal';
                    item.style.transform = 'scale(1)';
                }
            });
        }

        function getPickerValue() {
            let h = Math.round(colHour.scrollTop / itemHeight);
            let m = Math.round(colMinute.scrollTop / itemHeight);
            return { h, m };
        }

        // æ‰“å¼€å¼¹çª—
        function openPicker() {
            modalOverlay.classList.add('open');
            pickerModal.classList.add('open');
        }

        // å…³é—­å¼¹çª—
        function closePicker() {
            modalOverlay.classList.remove('open');
            pickerModal.classList.remove('open');
        }

        // æ›¿æ¢æ•´ä¸ª confirmPicker å‡½æ•°
        function confirmPicker() {
            const { h, m } = getPickerValue();
            const totalMins = h * 60 + m;

            if (totalMins === 0) {
                alert("è¯·è‡³å°‘è®¾ç½® 1 åˆ†é’Ÿ");
                return;
            }

            totalDurationMinutes = totalMins;
            
            // 1. æ›´æ–°å³ä¾§æ•°å€¼æ˜¾ç¤º
            const displayVal = (totalMins / 60).toFixed(1);
            const displayEl = document.getElementById('display-hours');
            const unitEl = document.getElementById('display-unit');
            
            displayEl.innerText = displayVal; // æ˜¾ç¤ºæ•°å­—
            unitEl.style.display = 'inline';  // æ˜¾ç¤ºâ€œå°æ—¶â€å•ä½

            // åˆ é™¤æˆ–æ³¨é‡Šæ‰ä¹‹å‰ç»™çˆ¶å®¹å™¨åŠ çº¿çš„ä»£ç ï¼š
            // document.querySelector('.time-value-wrapper').style.borderBottom = '2px solid #2196F3';

            // æ”¹ä¸ºï¼šç»™æ•°å­—å…ƒç´ æœ¬èº«åŠ çº¿ï¼Œå¹¶åŠ ä¸€ç‚¹ç‚¹åº•éƒ¨å†…è¾¹è·è®©çº¿å’Œå­—ä¸æŒ¨å¤ªè¿‘
            displayEl.style.borderBottom = '2px solid #2196F3';
            displayEl.style.paddingBottom = '4px'; 
            // 2. æ›´æ–°å·¦ä¾§æç¤ºæ–‡å­—é¢œè‰²å’Œå†…å®¹
            const hintEl = document.getElementById('end-time-hint');
            hintEl.style.color = '#dba859'; // å˜æˆé‡‘/æ©™è‰²
            
            calculateEndTime(totalMins); // è®¡ç®—å¹¶æ˜¾ç¤ºç»“æŸæ—¶é—´

            closePicker();
        }

        function calculateEndTime(minutes) {
            const now = new Date();
            const end = new Date(now.getTime() + minutes * 60000);
            const endStr = `${end.getHours().toString().padStart(2,'0')}:${end.getMinutes().toString().padStart(2,'0')}`;
            endTimeHint.innerText = `${endStr} ä¼šæš‚åœä¸”æé†’ç»“æŸè®¡æ—¶`;
        }

        // ================= 2. è®¡æ—¶å™¨é€»è¾‘ =================

// 1. å¼€å§‹ä¸“æ³¨
function startFocus() {
    // ä¿å­˜å†å²è®°å½•
    if(typeof saveTaskToHistory === 'function') saveTaskToHistory(taskNameInput.value);

    if (totalDurationMinutes <= 0) return alert('è¯·å…ˆè®¾ç½®æ—¶é•¿');
    
    // åˆ‡æ¢ç•Œé¢
    setupScreen.classList.remove('active');
    timerScreen.classList.add('active');
    
    // è·å–å®¹å™¨
    const timerContent = document.querySelector('.timer-content');
    
    // è¿›å…¥åˆå§‹æ¨¡å¼ (å¤§ä»»åŠ¡åï¼Œå°æ—¶é—´)
    timerContent.classList.add('initial-mode');
    
    // ç¡®ä¿æ²¡æœ‰æ®‹ç•™çš„æ ·å¼
    timerContent.style.transform = ''; 
    timerContent.classList.remove('rotate-out');

    // åˆå§‹åŒ–æ–‡å­—
    const userTask = taskNameInput.value || 'ä¸“æ³¨æ—¶åˆ»';
    timerTaskName.innerText = userTask; 
    
    // åº•éƒ¨åè¨€å…ˆéšè—
    alternatingText.classList.add('hidden'); 
    
    // é‡ç½®çŠ¶æ€
    elapsedMs = 0; 
    lastCycleIndex = 0;

    // --- ã€æ–°å¢ï¼šå½»åº•ä¿®å¤â€œè¿›åº¦ä¸é‡ç½®â€çš„é—®é¢˜ã€‘ ---
    currentResIndex = 0; 
    // ----------------------------------------

    updateResource(0, true); 
    
    // ç«‹å³å¼€å§‹
    startTimerLogic();
}
// åœ¨ startFocus å‡½æ•°å†…éƒ¨ï¼ŒstartTimerLogic() ä¹‹å‰æ·»åŠ ï¼š
sessionStartTimeObj = new Date(); // è®°å½•å½“å‰çœŸå®æ—¶é—´
        // 2. æ ¸å¿ƒè®¡æ—¶é€»è¾‘ (æ”¹ä¸º requestAnimationFrame)
function startTimerLogic() {
    if (isRunning) return;
    isRunning = true;
    pauseBtn.innerText = "æš‚åœ";

    startTime = performance.now();

    const loop = () => {
        const now = performance.now();
        const currentSessionMs = now - startTime; 
        const totalCurrentMs = elapsedMs + currentSessionMs;

        const totalSeconds = totalCurrentMs / 1000;

        // æ›´æ–°ç•Œé¢
        updateTimerUI(totalCurrentMs);
        
        // ã€æ–°å¢ã€‘å¼€å‘è€…æ¨¡å¼ï¼šæ»‘å—è·Ÿéšè‡ªåŠ¨æ›´æ–°
        if (isDevMode && devSlider) {
            devSlider.value = Math.floor(totalSeconds);
        }

        // æ£€æŸ¥åˆ‡å›¾é€»è¾‘ (æ¯20åˆ†é’Ÿ = 1200ç§’)
        const currentCycle = Math.floor(totalSeconds / 1200);
        if (currentCycle > lastCycleIndex) {
            lastCycleIndex = currentCycle;
            if(typeof currentResIndex !== 'undefined') {
                currentResIndex++;
                updateResource(currentResIndex);
            }
        }

        // æ£€æŸ¥ç»“æŸ
        if (totalSeconds >= totalDurationMinutes * 60) {
            elapsedMs = totalDurationMinutes * 60 * 1000; 
            updateTimerUI(elapsedMs); 
            
            // ã€æ–°å¢è¿™ä¸€è¡Œã€‘è‡ªç„¶ç»“æŸæ—¶ï¼Œå…ˆå…³æ‰è¿è¡ŒçŠ¶æ€ã€‚
            // è¿™æ ·è¿›å…¥ showSummaryModal() æ—¶ï¼Œå°±ä¸ä¼šé‡å¤ç´¯åŠ æ—¶é—´äº†ã€‚
            isRunning = false; 

            finishTimer();
            return; 
        }

        if (isRunning) {
            animationFrameId = requestAnimationFrame(loop);
        }
    };

    animationFrameId = requestAnimationFrame(loop);
    if(typeof startTextAnim === 'function') startTextAnim();
}

        // 3. ç•Œé¢æ›´æ–°é€»è¾‘ (æ¥æ”¶æ¯«ç§’å‚æ•°)
        function updateTimerUI(currentMs) {
            // --- A. æ›´æ–°æ—¶é—´æ–‡å­— (å‘ä¸‹å–æ•´æ˜¾ç¤º) ---
            const totalSecondsInt = Math.floor(currentMs / 1000);
            const h = Math.floor(totalSecondsInt / 3600);
            const m = Math.floor((totalSecondsInt % 3600) / 60);
            const s = totalSecondsInt % 60;
            timerDisplay.innerText = `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;

            // --- B. æ›´æ–°è¿›åº¦æ¡ (ä½¿ç”¨æ¯«ç§’è®¡ç®—ï¼Œä¸æ»‘æ— åœé¡¿) ---
            const cycleTimeMs = 1200 * 1000; // 20åˆ†é’Ÿ = 1200000æ¯«ç§’
            const totalTargetMs = totalDurationMinutes * 60 * 1000;

            // 1. å½“å‰å‘¨æœŸçš„èµ·å§‹æ¯«ç§’æ•°
            let currentCycleStartMs = Math.floor(currentMs / cycleTimeMs) * cycleTimeMs;
            
            // 2. è®¡ç®—è¿™ä¸€åœˆçš„æ€»æ—¶é•¿ (æ¯«ç§’)
            let remainingMsFromCycleStart = totalTargetMs - currentCycleStartMs;
            let currentRingDurationMs;

            if (remainingMsFromCycleStart < cycleTimeMs) {
                // æœ€åä¸€æ®µä¸è¶³20åˆ†é’Ÿ
                currentRingDurationMs = remainingMsFromCycleStart;
            } else {
                // æ ‡å‡†20åˆ†é’Ÿ
                currentRingDurationMs = cycleTimeMs;
            }

            // 3. å½“å‰è¿™ä¸€åœˆè·‘äº†å¤šå°‘æ¯«ç§’
            let timeInThisCycleMs = currentMs - currentCycleStartMs;

            // 4. è®¡ç®—æ¯”ä¾‹
            if (currentRingDurationMs <= 0) currentRingDurationMs = 1;
            let percent = timeInThisCycleMs / currentRingDurationMs;
            if (percent > 1) percent = 1; // å°é¡¶

            // 5. åº”ç”¨æ ·å¼
            const offset = circumference - (percent * circumference);
            progressRing.style.strokeDashoffset = offset;
        }

        // 4. æš‚åœ/ç»§ç»­
        function togglePause() {
            if (isRunning) {
                // === æš‚åœ ===
                isRunning = false;
                pauseBtn.innerText = "ç»§ç»­";
                
                // åœæ­¢åŠ¨ç”»å¸§
                cancelAnimationFrame(animationFrameId);
                clearInterval(textInterval);

                // å…³é”®ï¼šæŠŠè¿™æ®µæ—¶é—´è·‘çš„æ¯«ç§’æ•°ç´¯åŠ ä¿å­˜
                const now = performance.now();
                elapsedMs += (now - startTime);

            } else {
                // === ç»§ç»­ ===
                startTimerLogic(); // é‡æ–°å¼€å§‹å¾ªç¯ï¼ŒstartTime ä¼šè¢«é‡ç½®ä¸ºå½“å‰
            }
        }

function stopTimer() {
    // 1. åœæ­¢è¿è¡Œæ ‡å¿—
    isRunning = false;
    
    // 2. æ¸…é™¤æ ¸å¿ƒå¾ªç¯
    if (animationFrameId) cancelAnimationFrame(animationFrameId);
    if (textInterval) clearInterval(textInterval);
    
    // --- ã€æ–°å¢ï¼šå¿…é¡»æ‰‹åŠ¨æ€æ­»æ‰€æœ‰æ–‡å­—åŠ¨ç”»å®šæ—¶å™¨ã€‘ ---
    resetAllTextAnims(); 
    // -------------------------------------------
    
    // 3. åˆ‡æ¢é¡µé¢ UI
    timerScreen.classList.remove('active'); 
    setupScreen.classList.add('active');    
    
    // 4. é‡ç½®æŒ‰é’®æ–‡å­—
    if (pauseBtn) pauseBtn.innerText = "æš‚åœ";

    // 5. å…³é—­å¼€å‘è€…æ¨¡å¼
    if (typeof isDevMode !== 'undefined' && isDevMode) {
        exitDevMode();
    }
}

        function finishTimer() {
            stopTimer();
            alert('æ­å–œï¼Œä¸“æ³¨ä»»åŠ¡å®Œæˆï¼');
        }

        // ================= 3. èƒŒæ™¯ä¸æ–‡å­—åˆ‡æ¢ =================

// æ›¿æ¢ updateResource å‡½æ•°
function updateResource(idx, isFirstLoad = false) {
    // ç¡®ä¿ç´¢å¼•åœ¨èŒƒå›´å†…
    const safeIndex = idx % resources.length;
    const data = resources[safeIndex];
    
    // === ä¿®æ”¹ç‚¹ï¼šä¼˜å…ˆä½¿ç”¨å†…å­˜é‡Œçš„ Blob åœ°å€ ===
    // å¦‚æœå†…å­˜é‡Œæœ‰(loadedImages)ï¼Œå°±ç”¨å†…å­˜çš„ï¼›è¿˜æ²¡æœ‰å°±ç”¨åŸå§‹çš„(data.img)
    const finalImgUrl = loadedImages[safeIndex] || data.img;
    
    const tempImg = new Image();
    tempImg.src = finalImgUrl;
    
    tempImg.onload = () => {
        bgLayer.style.backgroundImage = `url('${finalImgUrl}')`;
    };
            
            // 2. å¦‚æœä¸æ˜¯ç¬¬ä¸€æ¬¡åŠ è½½ï¼ˆä¸­é—´è‡ªåŠ¨åˆ‡å›¾ï¼‰ï¼ŒæŒ‰æ­£å¸¸é€»è¾‘æ·¡å…¥æ·¡å‡º
            if (!isFirstLoad) {
                timerTaskName.classList.add('hidden');
                alternatingText.classList.add('hidden');
                setTimeout(() => {
                    timerTaskName.innerText = data.title;
                    alternatingText.innerText = data.quote;
                    timerTaskName.classList.remove('hidden');
                    alternatingText.classList.remove('hidden');
                }, 1000);
            } 
            // å¦‚æœæ˜¯ isFirstLoad (åˆšå¼€å§‹)ï¼Œæ–‡å­—ç”± startFocus å’Œ startTextAnim æ§åˆ¶ï¼Œè¿™é‡Œä¸æ“ä½œ
        }

// æ›¿æ¢åŸæœ‰çš„ startTextAnim
function startTextAnim() {
    resetAllTextAnims(); // å…ˆæ¸…ç©ºæ—§çš„

    const data = resources[currentResIndex % resources.length];
    const timerContent = document.querySelector('.timer-content');

    // === é˜¶æ®µ1: ç¿»è½¬åŠ¨ç”» (0s - 2s) ===
    animTimeout1 = setTimeout(() => {
        timerContent.style.transition = 'transform 0.5s linear';
        timerContent.classList.add('rotate-out');
        alternatingText.classList.add('hidden');
        
        animTimeout2 = setTimeout(() => {
            timerContent.style.opacity = '0';
            timerContent.classList.remove('initial-mode');
            
            timerTaskName.innerText = data.title;
            alternatingText.innerText = data.quote;
            
            timerContent.style.transition = 'none';
            timerContent.style.transform = 'perspective(600px) rotateY(-90deg)';
            timerContent.classList.remove('rotate-out');
            void timerContent.offsetWidth; 

            requestAnimationFrame(() => {
                timerContent.style.opacity = '1';
                timerContent.style.transition = 'transform 0.5s linear';
                timerContent.style.transform = 'perspective(600px) rotateY(0deg)';
                alternatingText.classList.remove('hidden');
                
                // æ¢å¤è¿‡æ¸¡æ ·å¼
                setTimeout(() => {
                    timerTaskName.style.transition = 'opacity 1.5s ease-in-out, font-size 0.1s';
                    alternatingText.style.transition = 'opacity 1.5s ease-in-out';
                }, 500);
            });
            
        }, 500); 
    }, 1500);

    // === é˜¶æ®µ2: 10ç§’åå¯åŠ¨å‘¼å¸ ===
    // è¿™é‡Œä¸å†ç”¨å†™æ­»çš„ setTimeoutï¼Œè€Œæ˜¯å­˜èµ·æ¥
    breatheStartTimeout = setTimeout(() => {
        if(isRunning) {
            startBreathingOnly();
        }
    }, 10000);
}
        // ================= åˆå§‹åŒ– =================
        initPicker();

        // ================= å†å²è®°å½•é€»è¾‘ =================

        const taskInput = document.getElementById('task-input');
        const historyDropdown = document.getElementById('history-dropdown');

        // ä»æœ¬åœ°å­˜å‚¨è·å–å†å²æ•°æ® { "ä»»åŠ¡å": æ¬¡æ•° }
        function getHistory() {
            return JSON.parse(localStorage.getItem('taskHistory')) || {};
        }

        // ä¿®æ”¹ï¼šæ¸²æŸ“ä¸‹æ‹‰èœå•
function showHistoryDropdown() {
    const history = getHistory(); // è·å– {"èƒŒå•è¯": 5, "çœ‹ä¹¦": 2}
    const list = [];

    // ç­›é€‰ï¼šé€»è¾‘ä¿æŒä¸å˜ (æ­¤å¤„ä»£ç æ˜¯ >=2ï¼Œå¦‚æœä½ æƒ³æ”¹æˆ >3ï¼Œè¯·æŠŠä¸‹é¢çš„ 2 æ”¹æˆ 4)
    for (let [name, count] of Object.entries(history)) {
        if (count >= 2) { 
            list.push(name);
        }
    }

    if (list.length === 0) {
        historyDropdown.style.display = 'none';
        return;
    }

    // ç”Ÿæˆ HTMLï¼šå·¦å³åˆ†æ ç»“æ„
    let html = '';
    list.forEach(name => {
        // æ³¨æ„ï¼šonmousedown æ¯” onclick æ›´æ—©è§¦å‘ï¼Œé˜²æ­¢ blur äº‹ä»¶å…ˆæ‰§è¡Œå¯¼è‡´æ— æ³•ç‚¹å‡»
        html += `
            <div class="history-item">
                <!-- å·¦è¾¹ï¼šç‚¹å‡»å¡«å…¥æ–‡å­— -->
                <div class="history-item-text" onmousedown="selectHistory('${name}')">${name}</div>
                <!-- å³è¾¹ï¼šç‚¹å‡»åˆ é™¤ (ä¼ å…¥ event ç”¨äºé˜»æ­¢å†’æ³¡) -->
                <div class="history-item-del" onmousedown="deleteTaskSuggestion('${name}', event)">Ã—</div>
            </div>
        `;
    });
    historyDropdown.innerHTML = html;
    historyDropdown.style.display = 'block';
}

// æ–°å¢ï¼šåˆ é™¤ä¸‹æ‹‰å»ºè®® (æ— ç¡®è®¤)
function deleteTaskSuggestion(name, event) {
    // é˜»æ­¢äº‹ä»¶å†’æ³¡ï¼Œé˜²æ­¢è§¦å‘ input çš„ blur æˆ–å…¶ä»–ç‚¹å‡»äº‹ä»¶
    if (event) event.stopPropagation();

    const history = getHistory();
    
    // åˆ é™¤è¯¥å±æ€§
    delete history[name];
    
    // ä¿å­˜å›æœ¬åœ°
    localStorage.setItem('taskHistory', JSON.stringify(history));
    
    // é‡æ–°æ¸²æŸ“ä¸‹æ‹‰èœå• (å¦‚æœåˆ å®Œç©ºäº†ä¼šè‡ªåŠ¨éšè—)
    showHistoryDropdown();
    
    // ä¿æŒè¾“å…¥æ¡†ç„¦ç‚¹ï¼Œé˜²æ­¢åˆ é™¤åèœå•æ¶ˆå¤±
    taskInput.focus(); 
}

        // é€‰æ‹©å†å²è®°å½•
        function selectHistory(name) {
            taskInput.value = name;
            historyDropdown.style.display = 'none';
        }

        // ä¿å­˜å†å²è®°å½• (åœ¨å¼€å§‹å­¦ä¹ æ—¶è°ƒç”¨)
        function saveTaskToHistory(taskName) {
            if (!taskName.trim()) return; // ç©ºä»»åŠ¡ä¸ä¿å­˜
            
            const history = getHistory();
            // è®¡æ•° + 1
            if (history[taskName]) {
                history[taskName]++;
            } else {
                history[taskName] = 1;
            }
            localStorage.setItem('taskHistory', JSON.stringify(history));
        }

        // --- äº‹ä»¶ç›‘å¬ ---

        // 1. è¾“å…¥æ¡†è·å¾—ç„¦ç‚¹æ—¶ï¼šå°è¯•æ˜¾ç¤ºå†å²è®°å½•
        taskInput.addEventListener('focus', showHistoryDropdown);

        // 2. è¾“å…¥æ¡†å¤±å»ç„¦ç‚¹æ—¶ï¼šå»¶è¿Ÿéšè—ï¼ˆä¸ºäº†è®©ç‚¹å‡»äº‹ä»¶èƒ½å…ˆè§¦å‘ï¼‰
        taskInput.addEventListener('blur', () => {
            setTimeout(() => {
                historyDropdown.style.display = 'none';
            }, 200);
        });

        // ================= ç»“æŸæ§åˆ¶é€»è¾‘ =================

 // 1. æ‹¦æˆªâ€œç»“æŸâ€æŒ‰é’®
function confirmEnd() {
    if (confirm("ç¡®å®šç»“æŸå¹¶ä¿å­˜è®°å½•å—ï¼Ÿ")) {
        showSummaryModal(); // ä»¥å‰æ˜¯ç›´æ¥ stopTimer()ï¼Œç°åœ¨æ”¹ä¸ºæ˜¾ç¤ºå¼¹çª—
    }
}

// 2. æ‹¦æˆªè‡ªåŠ¨å€’è®¡æ—¶ç»“æŸ
function finishTimer() {
    // æ’­æ”¾æç¤ºéŸ³æˆ–éœ‡åŠ¨ç­‰...
    alert('ä¸“æ³¨ä»»åŠ¡å®Œæˆï¼è¯·å¡«å†™å¿ƒå¾—ã€‚'); // å¯é€‰
    showSummaryModal();
}

// 3. æ˜¾ç¤ºæ€»ç»“å¼¹çª—é€»è¾‘
// 3. æ˜¾ç¤ºæ€»ç»“å¼¹çª—é€»è¾‘ (å·²ä¿®å¤æ—¶é•¿ä¸¢å¤± Bug)
function showSummaryModal() {
    // ã€å…³é”®ä¿®å¤å¼€å§‹ã€‘ï¼šå¦‚æœå½“å‰æ­£åœ¨è¿è¡Œï¼Œå¿…é¡»æŠŠâ€œæœ€åè¿™ä¸€æ®µâ€æ—¶é—´åŠ è¿›å»
    if (isRunning) {
        const now = performance.now();
        elapsedMs += (now - startTime);
        isRunning = false; // ç»“ç®—å®Œæ¯•åï¼Œå†æ ‡è®°ä¸ºåœæ­¢
    }
    // ã€å…³é”®ä¿®å¤ç»“æŸã€‘

    // åœæ­¢åŠ¨ç”»å¸§å’Œè½®æ’­
    if (animationFrameId) cancelAnimationFrame(animationFrameId);
    if (textInterval) clearInterval(textInterval);

    // è®¡ç®—æœ€ç»ˆæ—¶é•¿å­—ç¬¦ä¸²
    const finalMs = elapsedMs; // æ­¤æ—¶ elapsedMs å·²ç»æ˜¯å®Œæ•´çš„æ€»è€—æ—¶äº†
    const totalSec = Math.floor(finalMs / 1000);
    const h = Math.floor(totalSec / 3600);
    const m = Math.floor((totalSec % 3600) / 60);
    const s = totalSec % 60;
    const timeStr = `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;

    // å¡«å……å¼¹çª—æ•°æ®
    document.getElementById('summary-duration').innerText = timeStr;
    document.getElementById('summary-note').value = ''; // æ¸…ç©ºå¤‡æ³¨
    
    // æ˜¾ç¤ºå¼¹çª—
    document.getElementById('summary-overlay').classList.add('open');
    document.getElementById('summary-modal').classList.add('active');
}

function closeSummary(isSave) {
    // éšè—å¼¹çª—
    document.getElementById('summary-overlay').classList.remove('open');
    document.getElementById('summary-modal').classList.remove('active');
    
    // å¦‚æœç”¨æˆ·ç‚¹å‡»çš„æ˜¯â€œä¸ä¿å­˜â€æŒ‰é’®(isSaveä¸ºfalse)ï¼Œ
    // æˆ‘ä»¬ä¹Ÿè¦æ‰‹åŠ¨è°ƒç”¨ stopTimer è®©å®ƒå›ä¸»é¡µï¼Œå¦åˆ™å°±å¡åœ¨é»‘å±äº†
    if (!isSave) {
        stopTimer(); 
    }
}

        // ================= å…¨å±æ§åˆ¶é€»è¾‘ =================

        // ç›‘å¬å…¨å±€é”®ç›˜äº‹ä»¶
        document.addEventListener('keydown', (e) => {
            // æ£€æµ‹ç»„åˆé”®ï¼šShift + Enter
            if (e.shiftKey && e.key === 'Enter') {
                e.preventDefault(); // é˜²æ­¢å¯èƒ½äº§ç”Ÿçš„é»˜è®¤æ¢è¡Œç­‰è¡Œä¸º
                enterFullScreen();
            }
        });

        function enterFullScreen() {
            // è·å–æ–‡æ¡£æ ¹å…ƒç´  (<html>)
            const elem = document.documentElement;

            // æ£€æŸ¥å½“å‰æ˜¯å¦å·²ç»æ˜¯å…¨å±
            if (!document.fullscreenElement) {
                // å…¼å®¹ä¸åŒæµè§ˆå™¨çš„ API
                if (elem.requestFullscreen) {
                    elem.requestFullscreen();
                } else if (elem.webkitRequestFullscreen) { /* Safari */
                    elem.webkitRequestFullscreen();
                } else if (elem.msRequestFullscreen) { /* IE11 */
                    elem.msRequestFullscreen();
                }
            } else {
                // å¦‚æœç”¨æˆ·æƒ³ç”¨ Shift+Enter é€€å‡ºå…¨å±ä¹Ÿå¯ä»¥ï¼ˆå¯é€‰ï¼‰
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                }
            }
        }
        
        // ç›‘å¬å…¨å±å˜åŒ–äº‹ä»¶ï¼ˆå¯é€‰ï¼šç”¨äºè°ƒè¯•æˆ–åç»­æ‰©å±• UI å˜åŒ–ï¼‰
        document.addEventListener('fullscreenchange', () => {
            if (document.fullscreenElement) {
                console.log("å·²è¿›å…¥å…¨å±æ²‰æµ¸æ¨¡å¼");
            } else {
                console.log("å·²é€€å‡ºå…¨å±");
            }
        });

        // ================= å¼€å‘è€…æ¨¡å¼é€»è¾‘ =================

const devContainer = document.getElementById('dev-timeline-container');
const devSlider = document.getElementById('dev-slider');
let isDevMode = false;

// 1. ç›‘å¬è¾“å…¥æ¡†çš„â€œæš—å·â€
taskInput.addEventListener('keydown', (e) => {
    // æ£€æµ‹æ˜¯å¦æŒ‰ä¸‹å›è½¦
    if (e.key === 'Enter') {
        const val = taskInput.value.trim().toLowerCase();
        
        if (val === 'water') {
            e.preventDefault(); // é˜»æ­¢é»˜è®¤å›è½¦è¡Œä¸º
            activateDevMode();  // æ¿€æ´»å¼€å‘è€…æ¨¡å¼
        }
    }
});

// 2. æ¿€æ´»å¼€å‘è€…æ¨¡å¼å‡½æ•°
function activateDevMode() {
    isDevMode = true;
    
    totalDurationMinutes = 480; 
    devContainer.style.display = 'block';
    
    if(!taskInput.value || taskInput.value === 'water') {
        taskInput.value = "Developer Testing"; 
    }

    // æ­£å¸¸å¯åŠ¨
    startFocus();
    
    // --- ã€æ–°å¢é€»è¾‘ã€‘ ---
    // å› ä¸ºæ˜¯å¼€å‘è€…æ¨¡å¼ï¼Œä¸éœ€è¦çœ‹å¼€åœºåŠ¨ç”»ï¼Œæ‰€ä»¥æˆ‘ä»¬æ‰‹åŠ¨æ¸…ç†åŠ¨ç”»å¹¶ç§»é™¤å¤§å­—æ¨¡å¼
    resetAllTextAnims(); 
    const timerContent = document.querySelector('.timer-content');
    if(timerContent) {
        timerContent.classList.remove('initial-mode'); // æ‰‹åŠ¨ç§»é™¤ï¼Œç«‹åˆ»æ˜¾ç¤ºæ—¶é—´
    }
    // ------------------

    console.log("å¼€å‘è€…æ¨¡å¼å·²æ¿€æ´»ï¼šæ—¶é—´è½´å·²å¼€å¯");
}

// 3. æ—¶é—´è½´æ‹–åŠ¨ç›‘å¬ (ä¿®æ”¹ç‰ˆï¼šæ— ç¼ç©¿æ¢­ï¼Œä¸æš‚åœ)
// å¼€å‘è€…æ¨¡å¼ï¼šæ»‘å—ç›‘å¬ (æœ€ç»ˆä¼˜åŒ–ç‰ˆ)
devSlider.addEventListener('input', (e) => {
    if (!isDevMode) return;

    // 1. ã€å…³é”®ã€‘åªè¦æ‰‹ä¸€ç¢°æ»‘å—ï¼Œé©¬ä¸Šæ€æ‰æ‰€æœ‰åŠ¨ç”»ï¼Œä¿æŒæ–‡å­—å¸¸äº®
    resetAllTextAnims();
    // ä¹Ÿè¦æ¸…é™¤ä¹‹å‰çš„é˜²æŠ–è®¡æ—¶å™¨
    if (dragDebounceTimer) clearTimeout(dragDebounceTimer);

    // 2. æ›´æ–°æ—¶é—´é€»è¾‘ (ä¿æŒä¹‹å‰çš„æ— ç¼ç©¿æ¢­é€»è¾‘)
    const sliderSeconds = parseInt(e.target.value);
    const sliderMs = sliderSeconds * 1000;

    if (isRunning) {
        startTime = performance.now();
        elapsedMs = sliderMs;
    } else {
        elapsedMs = sliderMs;
    }
    updateTimerUI(sliderMs);

    // 3. èµ„æºåˆ‡æ¢é€»è¾‘
    const correctCycleIndex = Math.floor(sliderSeconds / 1200);
    if (correctCycleIndex !== currentResIndex) {
        currentResIndex = correctCycleIndex;
        updateResource(currentResIndex, true); 
        
        // å¼ºåˆ¶åˆ·æ–°æ–‡å­—å†…å®¹
        const data = resources[currentResIndex % resources.length];
        timerTaskName.innerText = data.title;
        alternatingText.innerText = data.quote;
    }

    // 4. ã€å…³é”®ã€‘é˜²æŠ–é‡å¯é€»è¾‘
    // å½“ç”¨æˆ·åœæ­¢æ‹–åŠ¨ 1000ms (1ç§’) åï¼Œåˆ¤æ–­æ˜¯å¦éœ€è¦æ¢å¤å‘¼å¸
    dragDebounceTimer = setTimeout(() => {
        // å¦‚æœå½“å‰æ—¶é—´å·²ç»è¶…è¿‡ 10ç§’ (10000ms)ï¼Œåˆ™å¯åŠ¨å‘¼å¸å¾ªç¯
        // å¦‚æœå°äº 10ç§’ï¼Œæˆ‘ä»¬å°±ä¿æŒå¸¸äº®ï¼Œä¸å¯åŠ¨å‘¼å¸ï¼Œç›´åˆ°æ—¶é—´è‡ªç„¶æµé€åˆ°10ç§’
        if (sliderMs >= 10000 && isRunning) {
            console.log("æ»‘å—åœæ­¢ï¼Œä¸”æ—¶é—´>10sï¼Œæ¢å¤å‘¼å¸åŠ¨ç”»");
            startBreathingOnly();
        } else if (isRunning) {
            // å¦‚æœæ—¶é—´ < 10sï¼Œæˆ‘ä»¬éœ€è¦è¡¥ä¸€ä¸ª timerï¼Œè®©å®ƒåœ¨åˆ°è¾¾ 10s æ—¶å¯åŠ¨
            const remaining = 10000 - sliderMs;
            console.log(`æ»‘å—åœæ­¢ï¼Œæ—¶é—´<10sï¼Œå°†åœ¨ ${remaining}ms åå¯åŠ¨å‘¼å¸`);
            breatheStartTimeout = setTimeout(() => {
                if(isRunning) startBreathingOnly();
            }, remaining);
        }
    }, 1000);
});

    // åœ¨ activateDevMode å‡½æ•°ä¸‹é¢æ·»åŠ è¿™ä¸ªå‡½æ•°

function exitDevMode() {
    // 1. å…³é—­å¼€å‘è€…æ¨¡å¼æ ‡è¯†
    isDevMode = false;
    
    // 2. éšè—æ—¶é—´è½´ç•Œé¢
    devContainer.style.display = 'none';
    
    // 3. æ¢å¤è‡ªåŠ¨è®¡æ—¶ï¼ˆå¦‚æœåœ¨æ‹–æ‹½è¿‡ç¨‹ä¸­æš‚åœäº†ï¼‰
    // å¦‚æœå½“å‰æ˜¯æš‚åœçŠ¶æ€ï¼Œæˆ‘ä»¬ä¿æŒæš‚åœï¼›
    // å¦‚æœæœ¬æ¥å°±åœ¨è¿è¡Œï¼Œæˆ–è€…æˆ‘ä»¬æƒ³è®©å®ƒè‡ªåŠ¨ç»§ç»­ï¼Œå¯ä»¥åšä¸ªåˆ¤æ–­ã€‚
    // è¿™é‡Œä¸ºäº†ä½“éªŒæµç•…ï¼Œå¦‚æœä½ å…³é—­äº†è°ƒè¯•æ¡ï¼Œæˆ‘ä»¬é»˜è®¤å¸®ä½ æ¢å¤â€œè¿è¡Œâ€çŠ¶æ€ï¼ˆé™¤éä½ æ‰‹åŠ¨ç‚¹äº†æš‚åœï¼‰
    if (!isRunning && pauseBtn.innerText === "ç»§ç»­") {
        // å¦‚æœæ˜¯æš‚åœçŠ¶æ€ï¼Œä»€ä¹ˆéƒ½ä¸åšï¼Œç­‰å¾…ç”¨æˆ·ç‚¹ç»§ç»­
    } else if (!isRunning) {
        // å¦‚æœæ˜¯å› ä¸ºæ‹–æ‹½å¯¼è‡´çš„ä¸´æ—¶æš‚åœï¼Œæ¢å¤è¿è¡Œ
        togglePause(); 
    }

    console.log("å¼€å‘è€…æ¨¡å¼å·²å…³é—­ï¼Œå›å½’æ­£å¸¸æ—¶é—´æµ");
}

// ================= å†å²è®°å½•ä¸å¯¼å‡ºé€»è¾‘ =================

// 1. ä¿å­˜å¹¶é€€å‡º (Save & Exit)
// 1. ä¿å­˜å¹¶é€€å‡º (Save & Exit)
function saveAndExit() {
    // 1. è·å–è¾“å…¥å†…å®¹
    const note = document.getElementById('summary-note').value;
    
    // ã€å…³é”®ä¿®æ”¹ã€‘ï¼š
    // ä¹‹å‰æ˜¯æŠ“å– #timer-task-name (å®ƒä¼šè¢«åŠ¨ç”»æ”¹æˆâ€œå¤§çˆ†ç‚¸â€ç­‰)
    // ç°åœ¨æ”¹ä¸ºæŠ“å– #task-input (ç”¨æˆ·æœ€åˆåœ¨è®¾ç½®é¡µå¡«å†™çš„çœŸå®ä»»åŠ¡)
    const taskName = document.getElementById('task-input').value.trim() || 'ä¸“æ³¨æ—¶åˆ»';
    
    // 2. è®¡ç®—æ—¶é•¿
    const totalSec = Math.floor(elapsedMs / 1000);
    const h = Math.floor(totalSec / 3600);
    const m = Math.floor((totalSec % 3600) / 60);
    const s = totalSec % 60;
    const durationStr = `${h}å°æ—¶${m}åˆ†${s}ç§’`;

    // 3. æ ¼å¼åŒ–å¼€å§‹æ—¶é—´
    let startTimeStr = "æœªçŸ¥æ—¶é—´";
    if (sessionStartTimeObj && sessionStartTimeObj.toLocaleString) {
        startTimeStr = sessionStartTimeObj.toLocaleString();
    }

    // 4. æ„å»ºæ•°æ®å¯¹è±¡
    const record = {
        id: Date.now(),
        task: taskName, // ç°åœ¨è¿™é‡Œä¿å­˜çš„å°±æ˜¯æ­£ç¡®çš„ä»»åŠ¡åäº†
        startTime: startTimeStr,
        duration: durationStr,
        note: note
    };

    // 5. ä¿å­˜åˆ° LocalStorage (immersiveHistory)
    let historyList = JSON.parse(localStorage.getItem('immersiveHistory')) || [];
    historyList.unshift(record);
    localStorage.setItem('immersiveHistory', JSON.stringify(historyList));

    // 6. æ›´æ–°ç®€æ˜“ä¸‹æ‹‰å†å² (taskHistory)
    // æ³¨æ„ï¼šstartFocus æ—¶å·²ç»è®°è¿‡ä¸€æ¬¡äº†ï¼Œè¿™é‡Œå¦‚æœä¸æƒ³é‡å¤è®¡æ•°ï¼Œå¯ä»¥æ³¨é‡Šæ‰ä¸‹é¢è¿™å‡ è¡Œ
    if (typeof saveTaskToHistory === 'function') {
        saveTaskToHistory(taskName);
    }

    // 7. å…³é—­å¼¹çª—
    closeSummary(true);

    // 8. è°ƒç”¨åœæ­¢å‡½æ•°ä»¥è¿”å›ä¸»é¡µ
    stopTimer(); 
}

// 2. æ‰“å¼€å†å²è®°å½•åˆ—è¡¨
// ä¿®æ”¹ï¼šæ‰“å¼€å†å²è®°å½•åˆ—è¡¨ (å¢åŠ äº† index å‚æ•°ç”¨äºåˆ é™¤å®šä½)
function openHistoryModal() {
    const list = JSON.parse(localStorage.getItem('immersiveHistory')) || [];
    const container = document.getElementById('history-list-content');
    
    if (list.length === 0) {
        container.innerHTML = '<div class="empty-tip">æš‚æ— å­¦ä¹ è®°å½•</div>';
    } else {
        let html = '';
        // éå†æ—¶åŠ ä¸Š indexï¼Œæ–¹ä¾¿åˆ é™¤
        list.forEach((item, index) => {
            html += `
                <div class="history-row">
                    <!-- åˆ é™¤æŒ‰é’®ï¼šä¼ å…¥ index -->
                    <div class="btn-delete-record" onclick="deleteHistoryItem(${index})" title="åˆ é™¤æ­¤æ¡">Ã—</div>
                    
                    <div class="history-row-top">
                        <span>${item.task}</span>
                        <span>${item.duration}</span>
                    </div>
                    <div class="history-row-mid">
                        <span>${item.startTime}</span>
                    </div>
                    ${item.note ? `<div class="history-note">ğŸ“ ${item.note}</div>` : ''}
                </div>
            `;
        });
        container.innerHTML = html;
    }

    document.getElementById('history-overlay').classList.add('open');
    document.getElementById('history-modal').classList.add('active');
}

// æ–°å¢ï¼šåˆ é™¤å•æ¡å†å²è®°å½• (æ— ç¡®è®¤)
function deleteHistoryItem(index) {
    let list = JSON.parse(localStorage.getItem('immersiveHistory')) || [];
    
    // åˆ é™¤å¯¹åº”ç´¢å¼•çš„å…ƒç´ 
    list.splice(index, 1);
    
    // ä¿å­˜å›æœ¬åœ°
    localStorage.setItem('immersiveHistory', JSON.stringify(list));
    
    // ç«‹å³é‡æ–°æ¸²æŸ“åˆ—è¡¨
    openHistoryModal();
}

function closeHistoryModal() {
    document.getElementById('history-overlay').classList.remove('open');
    document.getElementById('history-modal').classList.remove('active');
}

// 3. å¯¼å‡ºä¸º Excel (CSV æ ¼å¼)
function exportToExcel() {
    const list = JSON.parse(localStorage.getItem('immersiveHistory')) || [];
    if (list.length === 0) return alert('æš‚æ— æ•°æ®å¯å¯¼å‡º');

    // CSV è¡¨å¤´
    let csvContent = "ä»»åŠ¡åç§°,å¼€å§‹æ—¶é—´,ä¸“æ³¨æ—¶é•¿,å¿ƒå¾—å¤‡æ³¨\n";

    list.forEach(item => {
        // å¤„ç†å¤‡æ³¨ä¸­çš„æ¢è¡Œç¬¦å’Œé€—å·ï¼Œé˜²æ­¢ CSV æ ¼å¼é”™ä¹±
        let safeNote = item.note ? item.note.replace(/,/g, 'ï¼Œ').replace(/\n/g, ' ') : '';
        csvContent += `${item.task},${item.startTime},${item.duration},"${safeNote}"\n`;
    });

    // åˆ›å»º Blob å¯¹è±¡ (åŠ ä¸Š \uFEFF æ˜¯ä¸ºäº†è®© Excel æ­£ç¡®è¯†åˆ«ä¸­æ–‡ UTF-8)
    const blob = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8;' });
    
    // åˆ›å»ºä¸‹è½½é“¾æ¥
    const link = document.createElement("a");
    const url = URL.createObjectURL(blob);
    
    // ç”Ÿæˆæ–‡ä»¶åï¼šä¸“æ³¨è®°å½•_20231027.csv
    const date = new Date();
    const dateStr = `${date.getFullYear()}${date.getMonth()+1}${date.getDate()}`;
    
    link.setAttribute("href", url);
    link.setAttribute("download", `ä¸“æ³¨è®°å½•_${dateStr}.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

// A. å¼ºåŠ›æ¸…é™¤æ‰€æœ‰æ–‡å­—åŠ¨ç”» (è®©æ–‡å­—ä¿æŒé™æ­¢å¯è§)
function resetAllTextAnims() {
    // 1. æ¸…é™¤æ‰€æœ‰å®šæ—¶å™¨
    if (textInterval) clearInterval(textInterval);
    if (animTimeout1) clearTimeout(animTimeout1);
    if (animTimeout2) clearTimeout(animTimeout2);
    if (animTimeout3) clearTimeout(animTimeout3);
    if (breatheStartTimeout) clearTimeout(breatheStartTimeout);

    // 2. å¼ºåˆ¶æ˜¾ç¤ºæ–‡å­—
    const timerContent = document.querySelector('.timer-content');
    if (timerContent) {
        timerContent.style.opacity = '1';
        
        // ã€å…³é”®æ”¹åŠ¨ã€‘ï¼šè¿™é‡Œåƒä¸‡ä¸è¦ç§»é™¤ initial-modeï¼
        // å¦åˆ™æ­£å¸¸æ¨¡å¼ä¸‹çš„â€œå¼€åœºå¤§å­—åŠ¨ç”»â€ä¼šè¢«ç¬é—´ç ´åã€‚
        
        timerContent.classList.remove('rotate-out');
        timerContent.style.transition = ''; 
    }
    
    // 3. ç§»é™¤ hidden ç±»ï¼Œç¡®ä¿å¯è§
    timerTaskName.classList.remove('hidden');
    alternatingText.classList.remove('hidden');
}

// B. å•ç‹¬å¯åŠ¨å‘¼å¸å¾ªç¯ (ä¸å«ç¿»è½¬)
function startBreathingOnly() {
    // å…ˆæ¸…é™¤å¯èƒ½å­˜åœ¨çš„å¾ªç¯
    if (textInterval) clearInterval(textInterval);

    const runLoop = () => {
        if (!isRunning) return;
        // éš
        timerTaskName.classList.add('hidden');
        alternatingText.classList.add('hidden');
        
        // 10ç§’åæ˜¾
        animTimeout3 = setTimeout(() => {
            if(isRunning) {
                timerTaskName.classList.remove('hidden');
                alternatingText.classList.remove('hidden');
            }
        }, 10000);
    };

    // ç«‹å³æ‰§è¡Œä¸€æ¬¡
    runLoop();
    // ä¹‹åæ¯ 20ç§’å¾ªç¯
    textInterval = setInterval(runLoop, 20000);
}

// ================= ä¸‰è¿å‡»/ä¸‰è¿ç‚¹å…¨å±é€»è¾‘ (PC & æ‰‹æœºé€šç”¨) =================
        let tapCount = 0;
        let tapTimer = null;

        // å°† touchstart æ”¹ä¸º clickï¼Œè¿™æ ·ç”µè„‘é¼ æ ‡å’Œæ‰‹æœºè§¦æ‘¸éƒ½èƒ½è§¦å‘
        document.addEventListener('click', (e) => {
            // 1. é˜²å†²çªï¼šä½¿ç”¨ closest æ£€æµ‹ï¼Œ
            // åªè¦ç‚¹å‡»çš„æ˜¯æŒ‰é’®ã€è¾“å…¥æ¡†ã€é“¾æ¥æˆ–æ»šè½®åŒºåŸŸå†…éƒ¨ï¼Œéƒ½ä¸ç®—æ•°
            if (e.target.closest('button, input, textarea, a, .picker-column')) {
                tapCount = 0;
                return;
            }

            // 2. è®¡æ•°å¢åŠ 
            tapCount++;

            // 3. åˆ¤æ–­é€»è¾‘
            if (tapCount === 3) {
                // --- è§¦å‘å…¨å± ---
                enterFullScreen();
                
                // é‡ç½®
                tapCount = 0;
                if (tapTimer) clearTimeout(tapTimer);
                
                // å¯é€‰ï¼šåŠ ä¸ª console.log æ–¹ä¾¿è°ƒè¯•
                console.log("ä¸‰è¿å‡»è§¦å‘å…¨å±");
            } else {
                // --- è¿˜æ²¡åˆ°3æ¬¡ï¼Œè®¾ç½®è¶…æ—¶é‡ç½® ---
                if (tapTimer) clearTimeout(tapTimer);
                
                // 400æ¯«ç§’å†…å¿…é¡»ç‚¹ä¸‹ä¸€æ¬¡ï¼Œå¦åˆ™é‡ç½®
                // å¦‚æœè§‰å¾—æ‰‹é€Ÿè·Ÿä¸ä¸Šï¼Œå¯ä»¥æŠŠ 400 æ”¹æˆ 500
                tapTimer = setTimeout(() => {
                    tapCount = 0;
                }, 400); 
            }
        });

        // ================= æ•°æ®å¤‡ä»½ä¸æ¢å¤ (åŒæ­¥åŠŸèƒ½) =================

// 1. å¯¼å‡ºå¤‡ä»½ (JSON æ ¼å¼ï¼ŒåŒ…å«æ‰€æœ‰æ•°æ®)
function exportBackup() {
    const history = localStorage.getItem('immersiveHistory') || '[]';
    const taskStats = localStorage.getItem('taskHistory') || '{}';
    
    // æŠŠä¸¤ä»½æ•°æ®æ‰“åŒ…åœ¨ä¸€èµ·
    const backupData = {
        version: "1.0",
        date: new Date().toLocaleString(),
        history: JSON.parse(history),
        stats: JSON.parse(taskStats)
    };

    const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    
    const link = document.createElement("a");
    link.href = url;
    // æ–‡ä»¶åå¸¦ä¸Šæ—¶é—´ï¼Œæ–¹ä¾¿åŒºåˆ†
    const dateStr = new Date().toISOString().slice(0,10).replace(/-/g, "");
    link.download = `Timing_å¤‡ä»½_${dateStr}.json`;
    
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    alert("å¤‡ä»½æ–‡ä»¶å·²ä¸‹è½½ï¼\nè¯·æŠŠè¿™ä¸ª .json æ–‡ä»¶å‘åˆ°å¦ä¸€å°è®¾å¤‡ä¸Šè¿›è¡Œå¯¼å…¥ã€‚");
}

// 2. è§¦å‘å¯¼å…¥ (ç‚¹å‡»æŒ‰é’®æ¨¡æ‹Ÿç‚¹å‡»æ–‡ä»¶æ¡†)
function triggerImport() {
    document.getElementById('backup-file-input').click();
}

// 3. æ‰§è¡Œå¯¼å…¥
function importBackup(inputElement) {
    const file = inputElement.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const data = JSON.parse(e.target.result);
            
            // ç®€å•çš„æ ¼å¼æ ¡éªŒ
            if (!data.history || !data.stats) {
                alert("æ–‡ä»¶æ ¼å¼é”™è¯¯ï¼šè¿™ä¸æ˜¯ Timing çš„å¤‡ä»½æ–‡ä»¶ã€‚");
                return;
            }

            if (confirm(`æ£€æµ‹åˆ°å¤‡ä»½æ–‡ä»¶ï¼š\nå¤‡ä»½æ—¶é—´ï¼š${data.date}\nåŒ…å« ${data.history.length} æ¡è®°å½•\n\nã€æ³¨æ„ã€‘å¯¼å…¥å°†è¦†ç›–å½“å‰è®¾å¤‡çš„æ‰€æœ‰è®°å½•ï¼\nç¡®å®šè¦è¦†ç›–å—ï¼Ÿ`)) {
                
                // è¦†ç›–æœ¬åœ°æ•°æ®
                localStorage.setItem('immersiveHistory', JSON.stringify(data.history));
                localStorage.setItem('taskHistory', JSON.stringify(data.stats));
                
                alert("âœ… æ•°æ®æ¢å¤æˆåŠŸï¼");
                
                // åˆ·æ–°ç•Œé¢
                location.reload();
            }
        } catch (err) {
            console.error(err);
            alert("å¯¼å…¥å¤±è´¥ï¼šæ–‡ä»¶æŸåæˆ–æ ¼å¼ä¸æ­£ç¡®ã€‚");
        }
    };
    
    // è¯»å–æ–‡ä»¶æ–‡å­—
    reader.readAsText(file);
    
    // æ¸…ç©º inputï¼Œé˜²æ­¢åŒåæ–‡ä»¶æ— æ³•å†æ¬¡è§¦å‘
    inputElement.value = ''; 
}

// ================= æ€§èƒ½ä¼˜åŒ–ï¼šå›¾ç‰‡é¢„åŠ è½½ =================

// ================= å¼ºåŠ›é¢„åŠ è½½ï¼šè½¬ä¸º Blob å†…å­˜æ•°æ® =================

// ç”¨äºå­˜å‚¨è½¬æ¢åçš„æœ¬åœ°å›¾ç‰‡åœ°å€
const loadedImages = {}; 

async function preloadAllImages() {
    console.log("æ­£åœ¨å¼ºåŠ›ä¸‹è½½æ‰€æœ‰å›¾ç‰‡åˆ°å†…å­˜...");
    
    // æˆ‘ä»¬ä½¿ç”¨ Promise.all å¹¶å‘ä¸‹è½½æ‰€æœ‰å›¾ç‰‡
    const promises = resources.map(async (item, index) => {
        try {
            // 1. å‘èµ·è¯·æ±‚è·å–å›¾ç‰‡æ–‡ä»¶
            const response = await fetch(item.img);
            // 2. è½¬ä¸º Blob (äºŒè¿›åˆ¶å¤§å¯¹è±¡)
            const blob = await response.blob();
            // 3. ç”Ÿæˆä¸€ä¸ªæœ¬åœ°å†…å­˜é“¾æ¥ (ä¾‹å¦‚: blob:http://localhost/...)
            const objectURL = URL.createObjectURL(blob);
            
            // 4. å­˜å…¥å­—å…¸ï¼Œkey æ˜¯ç´¢å¼•ï¼Œvalue æ˜¯å†…å­˜åœ°å€
            loadedImages[index] = objectURL;
            
            // (å¯é€‰) å¯ä»¥åœ¨è¿™é‡Œæ›´æ–°è¿›åº¦æ¡ï¼Œæ¯”å¦‚ "å·²åŠ è½½ 1/24"
            // console.log(`å›¾ç‰‡ ${index} å·²é”å®šåœ¨å†…å­˜`);
            
        } catch (err) {
            console.error(`å›¾ç‰‡ ${item.title} åŠ è½½å¤±è´¥`, err);
            // å¤±è´¥ä¿åº•ï¼šå¦‚æœæœ‰ç½‘ç»œé—®é¢˜ï¼Œè¿˜æ˜¯ç”¨åŸé“¾æ¥
            loadedImages[index] = item.img;
        }
    });

    // ç­‰å¾…æ‰€æœ‰å›¾ç‰‡éƒ½å¤„ç†å®Œ
    await Promise.all(promises);
    console.log("æ‰€æœ‰å›¾ç‰‡å·²é©»ç•™å†…å­˜ï¼Œåå°åˆ‡æ¢æ— å‹åŠ›ï¼");
}

// é¡µé¢åŠ è½½æ—¶ç«‹å³æ‰§è¡Œ
preloadAllImages();
    </script>
</body>
</html>
